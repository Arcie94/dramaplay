---
import Layout from "../../layouts/Layout.astro";

export const prerender = false;
const API_BASE = "http://localhost:3000/api";
let siteLogo = "/favicon.png";
let debugMsg = "";
try {
    const settingsRes = await fetch(`${API_BASE}/settings?t=${Date.now()}`);
    if (settingsRes.ok) {
        const settingsData = await settingsRes.json();
        if (settingsData.site_logo) {
            siteLogo = settingsData.site_logo;
            debugMsg = "Loaded";
        } else {
            debugMsg = "No Logo in DB";
        }
    } else {
        debugMsg = `Fetch Status: ${settingsRes.status}`;
    }
} catch (e) {
    console.error("Error fetching settings:", e);
    debugMsg = `Error: ${e.message}`;
}
---

<Layout title="DramaPlay - Admin Panel">
    <div class="min-h-screen bg-zinc-950 text-white p-4 md:p-6 pb-24">
        <div class="max-w-7xl mx-auto">
            <header
                class="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-4 border-b border-zinc-800 pb-4"
            >
                <div class="flex items-center gap-2">
                    <img
                        src={siteLogo}
                        alt="Logo"
                        class="h-8 w-8 rounded-lg object-cover"
                    />
                    <div class="flex flex-col">
                        <span
                            class="text-lg font-bold tracking-tight text-white"
                            >DramaPlay</span
                        >
                    </div>
                </div>
                <div class="flex flex-wrap gap-2">
                    <!-- Global Nav Only -->
                    <a
                        href="/admin/users"
                        class="px-3 py-1.5 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2 text-zinc-300 hover:text-white border border-zinc-700 hover:border-zinc-600"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke-width="2"
                            stroke="currentColor"
                            class="w-4 h-4"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z"
                            ></path>
                        </svg>
                        Users
                    </a>
                    <a
                        href="/admin/settings"
                        class="px-3 py-1.5 bg-zinc-700 hover:bg-zinc-600 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2 text-white"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke-width="2"
                            stroke="currentColor"
                            class="w-4 h-4"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"
                            ></path>
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Settings
                    </a>
                    <button
                        id="btn-logout"
                        class="px-3 py-1.5 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2 text-red-400 hover:text-red-300 border border-zinc-800 hover:border-red-900/30"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke-width="2"
                            stroke="currentColor"
                            class="w-4 h-4"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9"
                            ></path>
                        </svg>
                        Logout
                    </button>
                </div>
            </header>

            <!-- Actions Bar -->
            <div class="flex flex-wrap gap-3 mb-8">
                <button
                    id="btn-ingest"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-semibold transition-colors flex items-center justify-center gap-2"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="2"
                        stroke="currentColor"
                        class="w-4 h-4"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m6.75 12l-3-3m0 0l-3 3m3-3v6"
                        ></path>
                    </svg>
                    Trigger Ingest
                </button>
                <button
                    id="btn-dedup"
                    class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm font-semibold transition-colors flex items-center justify-center gap-2"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="2"
                        stroke="currentColor"
                        class="w-4 h-4"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                        ></path>
                    </svg>
                    Run Dedup
                </button>
            </div>

            <!-- Stats Mockup -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 md:gap-6 mb-8">
                <div
                    class="bg-zinc-900 border border-zinc-800 rounded-xl p-4 md:p-5 flex flex-col justify-center"
                >
                    <h3
                        class="text-zinc-500 text-xs md:text-sm font-medium uppercase tracking-wider"
                    >
                        Total Dramas
                    </h3>
                    <p
                        id="stat-total"
                        class="text-2xl md:text-3xl font-bold text-white mt-2"
                    >
                        ...
                    </p>
                </div>
                <div
                    class="bg-zinc-900 border border-zinc-800 rounded-xl p-4 md:p-5 flex flex-col justify-center"
                >
                    <h3
                        class="text-zinc-500 text-xs md:text-sm font-medium uppercase tracking-wider"
                    >
                        Server Status
                    </h3>
                    <p
                        class="text-2xl md:text-3xl font-bold text-green-500 mt-2"
                    >
                        Online
                    </p>
                </div>
                <div
                    class="bg-zinc-900 border border-zinc-800 rounded-xl p-4 md:p-5 flex flex-col justify-center"
                >
                    <h3
                        class="text-zinc-500 text-xs md:text-sm font-medium uppercase tracking-wider"
                    >
                        Last Scan
                    </h3>
                    <p class="text-xl md:text-2xl font-bold text-white mt-2">
                        Just now
                    </p>
                </div>
            </div>

            <!-- Search & Filter -->
            <div class="flex gap-4 mb-6">
                <input
                    type="text"
                    id="admin-search"
                    placeholder="Search by title..."
                    class="flex-1 bg-zinc-900 border border-zinc-800 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-red-600 transition-colors"
                />
                <button
                    id="btn-refresh"
                    class="p-2.5 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-white"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="w-6 h-6"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99"
                        ></path>
                    </svg>
                </button>
            </div>

            <!-- Bulk Action Bar (Hidden by default) -->
            <div
                id="bulk-action-bar"
                class="hidden mb-4 items-center bg-red-900/20 border border-red-900/50 p-3 rounded-lg animate-in fade-in slide-in-from-top-2"
            >
                <span class="text-red-200 text-sm font-medium mr-auto pl-2">
                    <span id="selected-count">0</span> dramas selected
                </span>
                <button
                    id="btn-bulk-delete"
                    class="px-4 py-1.5 bg-red-600 hover:bg-red-700 text-white text-xs font-bold rounded shadow-lg shadow-red-900/20 transition-all flex items-center gap-2"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="2"
                        stroke="currentColor"
                        class="w-4 h-4"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"
                        ></path>
                    </svg>
                    Delete Selected
                </button>
            </div>

            <!-- Data Table Container -->
            <div
                class="bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden shadow-sm"
            >
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead
                            class="bg-zinc-950 text-zinc-400 text-xs uppercase font-semibold border-b border-zinc-800"
                        >
                            <tr>
                                <th class="p-4 w-10 text-center">
                                    <input
                                        type="checkbox"
                                        id="select-all"
                                        class="rounded bg-zinc-800 border-zinc-700 text-red-600 focus:ring-red-600 focus:ring-offset-zinc-900 cursor-pointer"
                                    />
                                </th>
                                <th class="p-4 w-20 text-center">Cover</th>
                                <th class="p-4 w-1/3 text-center">Title</th>
                                <th class="p-4 w-32 text-center">Episodes</th>
                                <th class="p-4 text-center">Genre</th>
                                <th class="p-4 text-center">Hero</th>
                                <th class="p-4 text-center w-32">Actions</th>
                            </tr>
                        </thead>
                        <tbody
                            id="admin-table-body"
                            class="divide-y divide-zinc-800 text-sm"
                        >
                            <!-- Rows injected via JS -->
                        </tbody>
                    </table>
                </div>
                <!-- Pagination -->
                <div
                    class="flex items-center justify-between p-4 border-t border-zinc-800 bg-zinc-900/50"
                >
                    <span id="page-info" class="text-zinc-500 text-sm"
                        >Page 1</span
                    >
                    <div class="flex gap-2">
                        <button
                            id="btn-prev"
                            class="px-3 py-1 bg-zinc-800 rounded hover:bg-zinc-700 disabled:opacity-50 text-xs font-medium"
                            >Prev</button
                        >
                        <button
                            id="btn-next"
                            class="px-3 py-1 bg-zinc-800 rounded hover:bg-zinc-700 disabled:opacity-50 text-xs font-medium"
                            >Next</button
                        >
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div
        id="edit-modal"
        class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 hidden backdrop-blur-sm"
    >
        <div
            class="bg-zinc-900 w-full max-w-lg rounded-xl border border-zinc-800 p-6 shadow-2xl"
        >
            <h2 class="text-xl font-bold text-white mb-4">Edit Drama</h2>
            <form id="edit-form" class="space-y-4">
                <input type="hidden" id="edit-id" />
                <div>
                    <label class="block text-xs font-medium text-zinc-400 mb-1"
                        >Title</label
                    >
                    <input
                        type="text"
                        id="edit-title"
                        class="w-full bg-black/50 border border-zinc-700 rounded px-3 py-2 text-white focus:border-red-600 focus:outline-none"
                    />
                </div>
                <div>
                    <label class="block text-xs font-medium text-zinc-400 mb-1"
                        >Cover URL</label
                    >
                    <input
                        type="text"
                        id="edit-cover"
                        class="w-full bg-black/50 border border-zinc-700 rounded px-3 py-2 text-white focus:border-red-600 focus:outline-none"
                    />
                </div>
                <div>
                    <label class="block text-xs font-medium text-zinc-400 mb-1"
                        >Total Episodes</label
                    >
                    <input
                        type="text"
                        id="edit-episodes"
                        class="w-full bg-black/50 border border-zinc-700 rounded px-3 py-2 text-white focus:border-red-600 focus:outline-none"
                    />
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button
                        type="button"
                        id="btn-cancel-edit"
                        class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 rounded text-sm text-white"
                        >Cancel</button
                    >
                    <button
                        type="submit"
                        class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded text-sm text-white font-bold"
                        >Save Changes</button
                    >
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div
        id="delete-modal"
        class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 hidden backdrop-blur-sm animate-in fade-in duration-200"
    >
        <div
            class="bg-zinc-900 w-full max-w-sm rounded-xl border border-white/10 p-6 shadow-2xl scale-in-95 animate-in duration-200"
        >
            <h3 class="text-xl font-bold text-white mb-2" id="delete-title">
                Delete Drama?
            </h3>
            <p class="text-zinc-400 mb-6 text-sm" id="delete-desc">
                Are you sure you want to delete this drama? This action cannot
                be undone.
            </p>
            <div class="flex justify-end gap-3">
                <button
                    type="button"
                    id="btn-cancel-delete"
                    class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-white text-sm font-medium rounded-lg transition-colors"
                >
                    Cancel
                </button>
                <button
                    type="button"
                    id="btn-confirm-delete"
                    class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg shadow-lg shadow-red-900/20 transition-all"
                >
                    Delete Drama
                </button>
            </div>
        </div>
    </div>
</Layout>

<script>
    const API_BASE = "http://localhost:3000/api";

    // AUTH CHECK
    const token = localStorage.getItem("admin_token");
    if (!token) {
        window.location.href = "/admin/login";
    }

    let currentPage = 1;
    let currentLimit = 10;
    let selectedIds: Set<string> = new Set();
    let isBulkDelete = false;

    const tableBody = document.getElementById("admin-table-body");
    const pageInfo = document.getElementById("page-info");
    const statTotal = document.getElementById("stat-total");
    const searchInput = document.getElementById(
        "admin-search",
    ) as HTMLInputElement;

    function getHeaders() {
        return {
            Authorization: token || "",
            "Content-Type": "application/json",
        };
    }

    async function fetchData(page = 1, query = "") {
        try {
            const res = await fetch(
                `${API_BASE}/admin/dramas?page=${page}&limit=${currentLimit}&q=${query}`,
                {
                    headers: getHeaders(),
                },
            );

            if (res.status === 401) {
                authFailed();
                return;
            }

            const json = await res.json();

            if (json.status === "success") {
                renderTable(json.data);
                if (statTotal) statTotal.textContent = json.total;
                if (pageInfo)
                    pageInfo.textContent = `Page ${json.page} of ${Math.ceil(json.total / json.limit)}`;
                currentPage = json.page;
            }
        } catch (err) {
            console.error(err);
            alert("Error fetching data: " + err);
        }
    }

    function authFailed() {
        localStorage.removeItem("admin_token");
        window.location.href = "/admin/login";
    }

    // Toggle Feature
    (window as any).toggleFeature = async (
        id: string,
        currentStatus: boolean,
    ) => {
        try {
            // Optimistic update handled by re-fetch
            const res = await fetch(`${API_BASE}/admin/dramas/${id}/feature`, {
                method: "PUT",
                headers: getHeaders(),
                body: JSON.stringify({ isFeatured: !currentStatus }), // Toggle status
            });

            if (res.ok) {
                fetchData(currentPage, searchInput.value); // Reload to reflect single-hero rule
            } else {
                alert("Failed to update feature status");
            }
        } catch (e) {
            console.error(e);
            alert("Error updating status");
        }
    };

    function renderTable(dramas: any[]) {
        if (!tableBody) return;

        // Check if all displayed items are selected to update header checkbox
        const allSelected =
            dramas.length > 0 && dramas.every((d) => selectedIds.has(d.bookId));
        const selectAllCb = document.getElementById(
            "select-all",
        ) as HTMLInputElement;
        if (selectAllCb) selectAllCb.checked = allSelected;

        tableBody.innerHTML = dramas
            .map(
                (d) => `
            <tr class="group hover:bg-zinc-900/50 transition-colors">
                <td class="p-4 text-center">
                    <input type="checkbox" class="drama-select rounded bg-zinc-800 border-zinc-700 text-red-600 focus:ring-red-600 focus:ring-offset-zinc-900 cursor-pointer" 
                    value="${d.bookId}" ${selectedIds.has(d.bookId) ? "checked" : ""}>
                </td>
                <td class="p-4 text-center">
                    <img src="${d.cover}" 
                         class="w-10 h-14 object-cover rounded bg-zinc-800 inline-block" 
                         loading="lazy"
                         onerror="this.src='/placeholder-poster.jpg'; this.onerror=null;">
                </td>
                <td class="p-4 font-medium text-white text-center">${d.judul}</td>
                <td class="p-4 text-zinc-400 text-center">${d.total_episode}</td>
                <td class="p-4 text-zinc-500 text-xs text-center">${d.genre || "-"}</td>
                <td class="p-4 text-center">
                    <button onclick="window.toggleFeature('${d.bookId}', ${d.isFeatured})" class="transition-transform active:scale-95">
                         ${d.isFeatured ? '<span class="text-2xl">⭐</span>' : '<span class="text-2xl grayscale opacity-30">⭐</span>'}
                    </button>
                </td>
                <td class="p-4 text-center">
                    <button onclick="window.openEdit('${d.bookId}')" class="text-blue-500 hover:text-blue-400 mr-3 text-xs font-semibold">Edit</button>
                    <button onclick="window.deleteDrama('${d.bookId}')" class="text-red-500 hover:text-red-400 text-xs font-semibold">Delete</button>
                </td>
            </tr>
        `,
            )
            .join("");

        // Store data for edit
        (window as any).currentData = dramas;

        // Re-attach checkbox listeners
        document.querySelectorAll(".drama-select").forEach((cb) => {
            cb.addEventListener("change", (e: any) => {
                const id = e.target.value;
                if (e.target.checked) selectedIds.add(id);
                else selectedIds.delete(id);
                updateBulkUI();
            });
        });
    }

    function updateBulkUI() {
        const bar = document.getElementById("bulk-action-bar");
        const count = document.getElementById("selected-count");
        const selectAllCb = document.getElementById(
            "select-all",
        ) as HTMLInputElement;

        if (count) count.textContent = selectedIds.size.toString();

        if (selectedIds.size > 0) {
            bar?.classList.remove("hidden");
            bar?.classList.add("flex");
        } else {
            bar?.classList.add("hidden");
            bar?.classList.remove("flex");
            if (selectAllCb) selectAllCb.checked = false;
        }
    }

    document
        .getElementById("select-all")
        ?.addEventListener("change", (e: any) => {
            const checked = e.target.checked;
            const boxes = document.querySelectorAll(".drama-select");
            boxes.forEach((cb: any) => {
                cb.checked = checked;
                if (checked) selectedIds.add(cb.value);
                else selectedIds.delete(cb.value);
            });
            updateBulkUI();
        });

    document
        .getElementById("btn-bulk-delete")
        ?.addEventListener("click", () => {
            if (selectedIds.size === 0) return;
            isBulkDelete = true;
            showDeleteModal(null);
        });

    // --- Init ---
    fetchData();

    // --- Listeners ---
    document.getElementById("btn-logout")?.addEventListener("click", () => {
        authFailed();
    });

    document.getElementById("btn-prev")?.addEventListener("click", () => {
        if (currentPage > 1) fetchData(currentPage - 1, searchInput.value);
    });

    document.getElementById("btn-next")?.addEventListener("click", () => {
        fetchData(currentPage + 1, searchInput.value);
    });

    document.getElementById("btn-refresh")?.addEventListener("click", () => {
        fetchData(currentPage, searchInput.value);
    });

    searchInput?.addEventListener("input", (e) => {
        // Debounce could be added here
        fetchData(1, (e.target as HTMLInputElement).value);
    });

    // --- Actions ---
    document
        .getElementById("btn-ingest")
        ?.addEventListener("click", async () => {
            if (!confirm("Start mass ingestion? This might take a while."))
                return;
            await fetch(`${API_BASE}/admin/action/ingest`, {
                method: "POST",
                headers: getHeaders(),
            });
            alert("Ingest process triggered in background.");
        });

    document
        .getElementById("btn-dedup")
        ?.addEventListener("click", async () => {
            if (!confirm("Start deduplication?")) return;
            await fetch(`${API_BASE}/admin/action/dedup`, {
                method: "POST",
                headers: getHeaders(),
            });
            alert("Deduplication triggered.");
        });

    // --- Edit Logic ---
    const editModal = document.getElementById("edit-modal");
    const editForm = document.getElementById("edit-form");
    const titleInput = document.getElementById(
        "edit-title",
    ) as HTMLInputElement;
    const coverInput = document.getElementById(
        "edit-cover",
    ) as HTMLInputElement;
    const epsInput = document.getElementById(
        "edit-episodes",
    ) as HTMLInputElement;
    const idInput = document.getElementById("edit-id") as HTMLInputElement;

    (window as any).openEdit = (id: string) => {
        const drama = (window as any).currentData.find(
            (d: any) => d.bookId === id,
        );
        if (!drama) return;

        idInput.value = drama.bookId;
        titleInput.value = drama.judul;
        coverInput.value = drama.cover;
        epsInput.value = drama.total_episode;

        editModal?.classList.remove("hidden");
    };

    document
        .getElementById("btn-cancel-edit")
        ?.addEventListener("click", () => {
            editModal?.classList.add("hidden");
        });

    editForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = idInput.value;

        await fetch(`${API_BASE}/admin/dramas/${id}`, {
            method: "PUT",
            headers: getHeaders(),
            body: JSON.stringify({
                judul: titleInput.value,
                cover: coverInput.value,
                total_episode: epsInput.value,
            }),
        });

        editModal?.classList.add("hidden");
        fetchData(currentPage, searchInput.value);
    });

    // --- Delete Logic ---
    const deleteModal = document.getElementById("delete-modal");
    const btnCancelDelete = document.getElementById("btn-cancel-delete");
    const btnConfirmDelete = document.getElementById("btn-confirm-delete");
    let dramaToDeleteId: string | null = null;

    function showDeleteModal(id: string | null) {
        dramaToDeleteId = id;

        const Title = document.getElementById("delete-title");
        const Desc = document.getElementById("delete-desc");

        if (deleteModal) {
            if (Title && Desc) {
                if (isBulkDelete) {
                    Title.textContent = `Delete ${selectedIds.size} Dramas?`;
                    Desc.textContent = `Are you sure you want to delete ${selectedIds.size} dramas? This action cannot be undone.`;
                } else {
                    Title.textContent = "Delete Drama?";
                    Desc.textContent =
                        "Are you sure you want to delete this drama? This action cannot be undone.";
                }
            }

            deleteModal.classList.remove("hidden");
            deleteModal.classList.add("flex");
        }
    }

    function hideDeleteModal() {
        dramaToDeleteId = null;
        isBulkDelete = false; // Reset mode
        if (deleteModal) {
            deleteModal.classList.add("hidden");
            deleteModal.classList.remove("flex");
        }
    }

    if (btnCancelDelete) {
        btnCancelDelete.addEventListener("click", hideDeleteModal);
    }

    // Explicitly handle outside click for Delete Modal too
    if (deleteModal) {
        deleteModal.addEventListener("click", (e) => {
            if (e.target === deleteModal) hideDeleteModal();
        });
    }

    if (btnConfirmDelete) {
        btnConfirmDelete.addEventListener("click", async () => {
            if (!dramaToDeleteId) return;

            await fetch(`${API_BASE}/admin/dramas/${dramaToDeleteId}`, {
                method: "DELETE",
                headers: getHeaders(),
            });
            fetchData(currentPage, searchInput.value);
            hideDeleteModal();
        });
    }

    (window as any).deleteDrama = (id: string) => {
        isBulkDelete = false;
        showDeleteModal(id);
    };
</script>
