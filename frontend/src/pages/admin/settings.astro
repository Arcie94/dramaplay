---
import Layout from "../../layouts/Layout.astro";
---

<Layout title="Admin Settings - DramaPlay">
  <div class="min-h-screen bg-black text-white p-6 pt-24">
    <div class="max-w-4xl mx-auto">
      <!-- Header -->
      <div class="flex items-center justify-between mb-8">
        <div>
          <h1 class="text-3xl font-bold">Settings</h1>
          <p class="text-zinc-400 mt-2">
            Manage application configuration and credentials
          </p>
        </div>
        <a
          href="/admin"
          class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-sm text-white transition-colors"
        >
          Back to Dashboard
        </a>
      </div>

      <!-- Settings Form -->
      <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-6 md:p-8">
        <form id="settings-form" class="space-y-6" onsubmit="return false;">
          <div>
            <h2
              class="text-xl font-semibold mb-4 border-b border-zinc-800 pb-2"
            >
              Authentication
            </h2>
            <div class="space-y-4">
              <div>
                <label
                  for="google_client_id"
                  class="block text-sm font-medium text-zinc-400 mb-1"
                  >Google OAuth Client ID</label
                >
                <input
                  type="text"
                  id="google_client_id"
                  name="google_client_id"
                  class="w-full bg-black/50 border border-zinc-700 rounded-lg px-4 py-2.5 text-white focus:border-red-600 focus:outline-none focus:ring-1 focus:ring-red-600 transition-colors"
                  placeholder="e.g. 123456789-abc.apps.googleusercontent.com"
                />
                <p class="text-xs text-zinc-500 mt-1">
                  Required for "Continue with Google" button. Get this from
                  Google Cloud Console.
                </p>
              </div>
            </div>
          </div>

          <div>
            <h2
              class="text-xl font-semibold mb-4 border-b border-zinc-800 pb-2"
            >
              Cloudflare Tunnel
            </h2>
            <div class="space-y-4">
              <div>
                <label
                  for="cloudflare_tunnel_token"
                  class="block text-sm font-medium text-zinc-400 mb-1"
                  >Tunnel Token</label
                >
                <input
                  type="password"
                  id="cloudflare_tunnel_token"
                  name="cloudflare_tunnel_token"
                  class="w-full bg-black/50 border border-zinc-700 rounded-lg px-4 py-2.5 text-white focus:border-red-600 focus:outline-none focus:ring-1 focus:ring-red-600 transition-colors"
                  placeholder="eyJ..."
                />
                <p class="text-xs text-zinc-500 mt-1">
                  Required for cloudflared container.
                </p>
              </div>
            </div>
          </div>

          <div>
            <h2
              class="text-xl font-semibold mb-4 border-b border-zinc-800 pb-2"
            >
              Security (Captcha)
            </h2>
            <div class="space-y-4">
              <div>
                <label
                  for="turnstile_site_key"
                  class="block text-sm font-medium text-zinc-400 mb-1"
                  >Turnstile Site Key</label
                >
                <input
                  type="text"
                  id="turnstile_site_key"
                  name="turnstile_site_key"
                  class="w-full bg-black/50 border border-zinc-700 rounded-lg px-4 py-2.5 text-white focus:border-red-600 focus:outline-none focus:ring-1 focus:ring-red-600 transition-colors"
                  placeholder="0x4AAAAAA..."
                />
              </div>
              <div>
                <label
                  for="turnstile_secret_key"
                  class="block text-sm font-medium text-zinc-400 mb-1"
                  >Turnstile Secret Key</label
                >
                <input
                  type="text"
                  id="turnstile_secret_key"
                  name="turnstile_secret_key"
                  class="w-full bg-black/50 border border-zinc-700 rounded-lg px-4 py-2.5 text-white focus:border-red-600 focus:outline-none focus:ring-1 focus:ring-red-600 transition-colors"
                  placeholder="0x4AAAAAA..."
                />
                <p class="text-xs text-zinc-500 mt-1">
                  Get these from Cloudflare Dashboard > Turnstile.
                </p>
              </div>
            </div>
          </div>

          <div>
            <h2
              class="text-xl font-semibold mb-4 border-b border-zinc-800 pb-2"
            >
              General Settings
            </h2>
            <div class="space-y-4">
              <div>
                <label
                  for="app_version"
                  class="block text-sm font-medium text-zinc-400 mb-1"
                  >App Version</label
                >
                <input
                  type="text"
                  id="app_version"
                  name="app_version"
                  class="w-full bg-black/50 border border-zinc-700 rounded-lg px-4 py-2.5 text-white focus:border-red-600 focus:outline-none focus:ring-1 focus:ring-red-600 transition-colors"
                  placeholder="e.g. v1.2.0-beta"
                />
                <p class="text-xs text-zinc-500 mt-1">
                  Shown in Profile page footer.
                </p>
              </div>

              <div>
                <label class="block text-sm font-medium text-zinc-400 mb-1"
                  >Site Logo</label
                >

                <div class="flex flex-col gap-4">
                  <!-- Preview & Input -->
                  <div
                    class="flex items-center gap-4 bg-black/30 p-4 rounded-lg border border-zinc-800"
                  >
                    <div
                      class="w-16 h-16 bg-zinc-900 rounded-lg flex items-center justify-center overflow-hidden border border-zinc-700"
                    >
                      <img
                        id="logo-preview"
                        src="/favicon.png"
                        class="w-full h-full object-contain"
                        onerror="this.src='/logo-404.png'"
                      />
                    </div>
                    <div class="flex-1">
                      <input
                        type="file"
                        id="logo-upload"
                        accept="image/*"
                        class="hidden"
                      />
                      <div class="flex gap-2">
                        <button
                          type="button"
                          onclick="document.getElementById('logo-upload').click()"
                          class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-sm text-white font-medium transition-colors border border-zinc-600"
                        >
                          Choose Image
                        </button>
                        <input
                          type="text"
                          id="site_logo"
                          name="site_logo"
                          class="flex-1 bg-transparent border-none text-zinc-500 text-sm focus:ring-0"
                          placeholder="URL will appear here..."
                          readonly
                        />
                      </div>
                      <p class="text-xs text-zinc-500 mt-2">
                        Recommended: 200x200px (PNG/JPG)
                      </p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Site Favicon -->
              <div>
                <label class="block text-sm font-medium text-zinc-400 mb-1"
                  >Site Favicon</label
                >

                <div class="flex flex-col gap-4">
                  <!-- Preview & Input -->
                  <div
                    class="flex items-center gap-4 bg-black/30 p-4 rounded-lg border border-zinc-800"
                  >
                    <div
                      class="w-16 h-16 bg-zinc-900 rounded-lg flex items-center justify-center overflow-hidden border border-zinc-700"
                    >
                      <img
                        id="favicon-preview"
                        src="/favicon.png"
                        class="w-full h-full object-contain"
                        onerror="this.src='/logo-404.png'"
                      />
                    </div>
                    <div class="flex-1">
                      <input
                        type="file"
                        id="favicon-upload"
                        accept="image/*"
                        class="hidden"
                      />
                      <div class="flex gap-2">
                        <button
                          type="button"
                          onclick="document.getElementById('favicon-upload').click()"
                          class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-sm text-white font-medium transition-colors border border-zinc-600"
                        >
                          Choose Image
                        </button>
                        <input
                          type="text"
                          id="site_favicon"
                          name="site_favicon"
                          class="flex-1 bg-transparent border-none text-zinc-500 text-sm focus:ring-0"
                          placeholder="URL will appear here..."
                          readonly
                        />
                      </div>
                      <p class="text-xs text-zinc-500 mt-2">
                        Recommended: 32x32px or 64x64px (PNG/ICO)
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>

        <!-- Social Share Image -->
        <div>
          <h2 class="text-xl font-semibold mb-4 border-b border-zinc-800 pb-2">
            Social Media Sharing
          </h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-zinc-400 mb-1"
                >Social Share Image (OG:Image)</label
              >

              <div class="flex flex-col gap-4">
                <!-- Preview & Input -->
                <div
                  class="flex items-center gap-4 bg-black/30 p-4 rounded-lg border border-zinc-800"
                >
                  <div
                    class="w-40 h-24 bg-zinc-900 rounded-lg flex items-center justify-center overflow-hidden border border-zinc-700"
                  >
                    <img
                      id="social-preview"
                      src="/pwa-512x512.png"
                      class="w-full h-full object-cover"
                      onerror="this.src='/logo-404.png'"
                    />
                  </div>
                  <div class="flex-1">
                    <input
                      type="file"
                      id="social-upload"
                      accept="image/*"
                      class="hidden"
                    />
                    <div class="flex gap-2">
                      <button
                        type="button"
                        onclick="document.getElementById('social-upload').click()"
                        class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-sm text-white font-medium transition-colors border border-zinc-600"
                      >
                        Choose Image
                      </button>
                      <input
                        type="text"
                        id="social_image"
                        name="social_image"
                        class="flex-1 bg-transparent border-none text-zinc-500 text-sm focus:ring-0"
                        placeholder="URL will appear here..."
                        readonly
                      />
                    </div>
                    <p class="text-xs text-zinc-500 mt-2">
                      Recommended: 1200x630px (JPG) - Max 300KB
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div>
          <h2 class="text-xl font-semibold mb-4 border-b border-zinc-800 pb-2">
            Analytics
          </h2>
          <div class="space-y-4">
            <div>
              <label
                for="ga_measurement_id"
                class="block text-sm font-medium text-zinc-400 mb-1"
                >Google Analytics Measurement ID</label
              >
              <input
                type="text"
                id="ga_measurement_id"
                name="ga_measurement_id"
                class="w-full bg-black/50 border border-zinc-700 rounded-lg px-4 py-2.5 text-white focus:border-red-600 focus:outline-none focus:ring-1 focus:ring-red-600 transition-colors"
                placeholder="e.g. G-XXXXXXXXXX"
              />
              <p class="text-xs text-zinc-500 mt-1">
                Found in GA4 Admin > Data Streams.
              </p>
            </div>
          </div>
        </div>

        <div class="flex justify-end pt-4">
          <!-- Changed to type="button" and direct onclick -->
          <button
            type="button"
            id="btn-save"
            onclick="window.handleSaveSettings()"
            class="px-6 py-2.5 bg-red-600 hover:bg-red-700 rounded-lg text-white font-bold shadow-lg shadow-red-900/20 transition-all active:scale-95"
          >
            Save Changes
          </button>
        </div>
      </div>
    </div>
  </div>
</Layout>
<!-- Toast Container -->
<div
  id="toast-container"
  class="fixed bottom-6 right-6 z-[60] flex flex-col gap-2 pointer-events-none"
>
</div>

<!-- CropperJS -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"
/>
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"
  is:inline></script>

<!-- Editor Modal -->
<div
  id="editor-modal"
  class="fixed inset-0 z-[60] bg-black/90 hidden flex-col items-center justify-center p-4 backdrop-blur-md"
>
  <div
    class="bg-zinc-900 w-full max-w-4xl h-[80vh] rounded-xl border border-zinc-700 flex flex-col shadow-2xl overflow-hidden"
  >
    <!-- Toolbar Top -->
    <div
      class="p-4 border-b border-zinc-800 flex justify-between items-center bg-zinc-950"
    >
      <h3 class="font-bold text-white">Edit Logo</h3>
      <button id="btn-close-editor" class="text-zinc-400 hover:text-white">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="w-6 h-6"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Canvas -->
    <div
      class="flex-1 bg-[#18181b] relative overflow-hidden flex items-center justify-center p-4"
    >
      <img id="image-to-edit" src="" class="max-w-full max-h-full block" />
    </div>

    <!-- Toolbar Bottom -->
    <div
      class="p-4 border-t border-zinc-800 bg-zinc-950 flex flex-wrap gap-4 justify-between items-center"
    >
      <div class="flex flex-wrap gap-2">
        <!-- Zoom -->
        <div
          class="flex rounded-md bg-zinc-800 overflow-hidden border border-zinc-700"
        >
          <button
            type="button"
            class="p-2 hover:bg-zinc-700 text-white"
            data-action="zoom-in"
            title="Zoom In"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              ><circle cx="11" cy="11" r="8"></circle><line
                x1="21"
                y1="21"
                x2="16.65"
                y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"
              ></line><line x1="8" y1="11" x2="14" y2="11"></line></svg
            >
          </button>
          <button
            type="button"
            class="p-2 hover:bg-zinc-700 text-white border-l border-zinc-700"
            data-action="zoom-out"
            title="Zoom Out"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              ><circle cx="11" cy="11" r="8"></circle><line
                x1="21"
                y1="21"
                x2="16.65"
                y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"
              ></line></svg
            >
          </button>
        </div>

        <!-- Rotate -->
        <div
          class="flex rounded-md bg-zinc-800 overflow-hidden border border-zinc-700"
        >
          <button
            type="button"
            class="p-2 hover:bg-zinc-700 text-white"
            data-action="rotate-left"
            title="Rotate Left"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              ><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"
              ></path><path d="M3 3v5h5"></path></svg
            >
          </button>
          <button
            type="button"
            class="p-2 hover:bg-zinc-700 text-white border-l border-zinc-700"
            data-action="rotate-right"
            title="Rotate Right"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              ><path d="M21 12a9 9 0 1 1-9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"
              ></path><path d="M21 3v5h-5"></path></svg
            >
          </button>
        </div>

        <!-- Flip -->
        <div
          class="flex rounded-md bg-zinc-800 overflow-hidden border border-zinc-700"
        >
          <button
            type="button"
            class="p-2 hover:bg-zinc-700 text-white"
            data-action="flip-h"
            title="Flip Horizontal"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              ><polyline points="16 3 21 3 21 8"></polyline><line
                x1="4"
                y1="20"
                x2="21"
                y2="3"></line><polyline points="21 16 21 21 16 21"
              ></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line
                x1="4"
                y1="4"
                x2="9"
                y2="9"></line></svg
            >
          </button>
          <button
            type="button"
            class="p-2 hover:bg-zinc-700 text-white border-l border-zinc-700"
            data-action="flip-v"
            title="Flip Vertical"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              ><polyline points="16 21 21 21 21 16"></polyline><line
                x1="12"
                y1="21"
                x2="12"
                y2="3"></line><polyline points="3 10 3 15 8 15"></polyline></svg
            >
          </button>
        </div>
      </div>

      <div class="flex gap-3">
        <button
          type="button"
          id="btn-crop-save"
          class="px-6 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-white font-bold shadow-lg shadow-red-900/20"
        >
          Crop & Upload
        </button>
      </div>
    </div>
  </div>
</div>

<script is:inline>
  // Ensure Window function is defined ASAP
  console.log("Settings script loaded");

  const API_BASE = "/api";
  const token = localStorage.getItem("admin_token");

  // --- Toast Logic ---
  function showToast(msg, type = "success") {
    const container = document.getElementById("toast-container");
    if (!container) return;

    const toast = document.createElement("div");
    toast.className = `pointer-events-auto px-4 py-3 rounded-lg text-white text-sm font-medium shadow-xl flex items-center gap-3 animate-in slide-in-from-bottom-5 duration-300 ${
      type === "success" ? "bg-green-600" : "bg-red-600"
    }`;
    toast.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                ${
                  type === "success"
                    ? '<path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />'
                    : '<path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />'
                }
            </svg>
            ${msg}
        `;

    container.appendChild(toast);

    // Remove after 3s
    setTimeout(() => {
      toast.classList.add("opacity-0", "translate-y-2", "transition-all");
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  if (!token) {
    window.location.href = "/admin/login";
  }

  // Define global function for button click
  window.handleSaveSettings = async function () {
    const clientIDInput = document.getElementById("google_client_id");
    const gaIDInput = document.getElementById("ga_measurement_id");
    const appVersionInput = document.getElementById("app_version");
    const cfTokenInput = document.getElementById("cloudflare_tunnel_token");
    const turnstileSiteInput = document.getElementById("turnstile_site_key");
    const turnstileSecretInput = document.getElementById(
      "turnstile_secret_key"
    );
    const logoInput = document.getElementById("site_logo");
    const faviconInput = document.getElementById("site_favicon");
    const socialInput = document.getElementById("social_image");

    const saveBtn = document.getElementById("btn-save");

    if (!clientIDInput || !saveBtn) {
      showToast("Error: Form elements not found", "error");
      return;
    }

    const originalText = saveBtn.innerText;
    saveBtn.innerText = "Saving...";
    saveBtn.disabled = true;

    try {
      const payload = {
        google_client_id: clientIDInput.value.trim(),
        ga_measurement_id: gaIDInput.value.trim(),
        app_version: appVersionInput.value.trim(),
        cloudflare_tunnel_token: cfTokenInput.value.trim(),
        turnstile_site_key: turnstileSiteInput.value.trim(),
        turnstile_secret_key: turnstileSecretInput.value.trim(),
        site_logo: logoInput.value.trim(),
        site_favicon: faviconInput.value.trim(),
      };

      if (socialInput.value) {
        payload.social_image = socialInput.value.trim();
      }

      const res = await fetch(`${API_BASE}/admin/settings/batch`, {
        method: "POST",
        headers: {
          Authorization: token || "",
          "Content-Type": "application/json",
        },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        throw new Error(`Failed to save settings: ${res.statusText}`);
      }

      const json = await res.json();
      showToast("Settings saved successfully!", "success");
    } catch (err) {
      console.error(err);
      showToast("Error saving settings", "error");
    } finally {
      saveBtn.innerText = originalText;
      saveBtn.disabled = false;
    }
  };

  // --- Editor & Helper Logic ---
  // (Simplified for inline context, using document selectors directly)

  // Crop & Upload
  // We need to re-scan for elements since we are not in DOMContentLoaded
  // But since this script is at the end of body, elements exist.

  const fileInput = document.getElementById("logo-upload");
  const faviconFileInput = document.getElementById("favicon-upload");
  const socialFileInput = document.getElementById("social-upload");

  const editorModal = document.getElementById("editor-modal");
  const imageToEdit = document.getElementById("image-to-edit");
  const btnCloseEditor = document.getElementById("btn-close-editor");
  const btnCropSave = document.getElementById("btn-crop-save");

  let cropper = null;
  let currentUploadTarget = "logo";

  function handleFileSelect(e, target) {
    const file = e.target.files[0];
    if (!file) return;

    currentUploadTarget = target;
    const reader = new FileReader();
    reader.onload = (ev) => {
      imageToEdit.src = ev.target.result;
      openEditor();
    };
    reader.readAsDataURL(file);
    e.target.value = "";
  }

  if (fileInput)
    fileInput.addEventListener("change", (e) => handleFileSelect(e, "logo"));
  if (faviconFileInput)
    faviconFileInput.addEventListener("change", (e) =>
      handleFileSelect(e, "favicon")
    );
  if (socialFileInput)
    socialFileInput.addEventListener("change", (e) =>
      handleFileSelect(e, "social")
    );

  function openEditor() {
    editorModal.classList.remove("hidden");
    editorModal.classList.add("flex");
    if (cropper) cropper.destroy();

    let aspectRatio = 1;
    if (currentUploadTarget === "social") aspectRatio = 1.91;

    cropper = new Cropper(imageToEdit, {
      viewMode: 1,
      dragMode: "move",
      aspectRatio: aspectRatio,
      autoCropArea: 0.8,
      restore: false,
      guides: true,
      center: true,
      highlight: false,
      cropBoxMovable: true,
      cropBoxResizable: true,
      toggleDragModeOnDblclick: false,
    });
  }

  function closeEditor() {
    editorModal.classList.add("hidden");
    editorModal.classList.remove("flex");
    if (cropper) {
      cropper.destroy();
      cropper = null;
    }
  }

  if (btnCloseEditor) btnCloseEditor.addEventListener("click", closeEditor);

  // Toolbar
  document.querySelectorAll("[data-action]").forEach((btn) => {
    btn.addEventListener("click", (e) => {
      if (!cropper) return;
      const action = e.currentTarget.getAttribute("data-action");
      if (action === "zoom-in") cropper.zoom(0.1);
      if (action === "zoom-out") cropper.zoom(-0.1);
      if (action === "rotate-left") cropper.rotate(-90);
      if (action === "rotate-right") cropper.rotate(90);
      if (action === "flip-h") cropper.scaleX(cropper.getData().scaleX * -1);
      if (action === "flip-v") cropper.scaleY(cropper.getData().scaleY * -1);
    });
  });

  if (btnCropSave) {
    btnCropSave.addEventListener("click", () => {
      if (!cropper) return;
      let width = 400,
        height = 400,
        format = "image/png",
        filename = "logo.png";

      if (currentUploadTarget === "favicon") {
        width = 64;
        height = 64;
        filename = "favicon.png";
      } else if (currentUploadTarget === "social") {
        width = 1200;
        height = 630;
        format = "image/jpeg";
        filename = "social-share.jpg";
      }

      cropper.getCroppedCanvas({ width, height }).toBlob(
        async (blob) => {
          const formData = new FormData();
          const ts = new Date().getTime();
          formData.append("file", blob, filename.replace(".", `_${ts}.`));

          btnCropSave.innerText = "Uploading...";
          btnCropSave.disabled = true;

          try {
            const res = await fetch(`${API_BASE}/admin/upload`, {
              method: "POST",
              headers: { Authorization: token || "" },
              body: formData,
            });
            const json = await res.json();
            if (json.status === "success") {
              const fullUrl = json.url;
              if (currentUploadTarget === "logo") {
                document.getElementById("site_logo").value = fullUrl;
                document.getElementById("logo-preview").src = fullUrl;
              } else if (currentUploadTarget === "favicon") {
                document.getElementById("site_favicon").value = fullUrl;
                document.getElementById("favicon-preview").src = fullUrl;
              } else if (currentUploadTarget === "social") {
                document.getElementById("social_image").value = fullUrl;
                document.getElementById("social-preview").src = fullUrl;
              }
              closeEditor();
              showToast("Image uploaded!", "success");
            } else {
              showToast("Upload failed: " + json.message, "error");
            }
          } catch (e) {
            console.error(e);
            showToast("Error uploading", "error");
          } finally {
            btnCropSave.innerText = "Crop & Upload";
            btnCropSave.disabled = false;
          }
        },
        format,
        0.9
      );
    });
  }

  // Fetch Settings Init
  async function fetchSettings() {
    try {
      const res = await fetch(`${API_BASE}/admin/settings`, {
        headers: { Authorization: token || "" },
      });
      const json = await res.json();
      if (json.status === "success" && json.data) {
        if (json.data.google_client_id)
          document.getElementById("google_client_id").value =
            json.data.google_client_id;
        if (json.data.ga_measurement_id)
          document.getElementById("ga_measurement_id").value =
            json.data.ga_measurement_id;
        if (json.data.cloudflare_tunnel_token)
          document.getElementById("cloudflare_tunnel_token").value =
            json.data.cloudflare_tunnel_token;
        if (json.data.turnstile_site_key)
          document.getElementById("turnstile_site_key").value =
            json.data.turnstile_site_key;
        if (json.data.turnstile_secret_key)
          document.getElementById("turnstile_secret_key").value =
            json.data.turnstile_secret_key;
        if (json.data.site_logo) {
          document.getElementById("site_logo").value = json.data.site_logo;
          document.getElementById("logo-preview").src = json.data.site_logo;
        }
        if (json.data.site_favicon) {
          document.getElementById("site_favicon").value =
            json.data.site_favicon;
          document.getElementById("favicon-preview").src =
            json.data.site_favicon;
        }
        if (json.data.social_image) {
          document.getElementById("social_image").value =
            json.data.social_image;
          document.getElementById("social-preview").src =
            json.data.social_image;
        }
      }
    } catch (err) {
      console.error(err);
    }
  }

  // Run init
  fetchSettings();
</script>
