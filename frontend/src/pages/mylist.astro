---
import Layout from "../layouts/Layout.astro";
---

<Layout title="DramaPlay - My List">
  <main class="pb-20 min-h-screen bg-black">
    <!-- Header -->
    <header
      class="sticky top-0 z-30 flex items-center justify-between bg-zinc-950/80 px-4 py-3 backdrop-blur-md border-b border-white/5"
    >
      <h1 class="text-lg font-bold text-white">My List</h1>
      <a href="/search" class="text-zinc-400">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="2"
          stroke="currentColor"
          class="w-6 h-6"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"
          ></path>
        </svg>
      </a>
    </header>

    <!-- List Container -->
    <div
      id="mylist-container"
      class="p-4 grid grid-cols-3 gap-3 md:grid-cols-4 lg:grid-cols-6 min-h-[50vh]"
    >
      <!-- Content will be injected here via JS -->
      <div
        class="col-span-full flex flex-col items-center justify-center py-20 text-zinc-500 gap-4"
      >
        <div
          class="w-8 h-8 border-2 border-red-600 border-t-transparent rounded-full animate-spin"
        >
        </div>
        <p class="text-sm">Loading your list...</p>
      </div>
    </div>

    <!-- Empty State Template (Hidden) -->
    <template id="empty-state">
      <div
        class="col-span-full flex flex-col items-center justify-center py-20 text-zinc-500 gap-4 text-center"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="w-16 h-16 text-zinc-700"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0111.186 0z"
          ></path>
        </svg>
        <p class="text-lg font-medium text-white">Your list is empty</p>
        <p class="text-sm max-w-xs">
          Add shows to your list to watch them later.
        </p>
        <a
          href="/"
          class="mt-4 px-6 py-2 bg-red-600 text-white rounded-full font-semibold text-sm shadow-lg shadow-red-900/50"
        >
          Browse Dramas
        </a>
      </div>
    </template>

    <!-- Bottom Nav -->
    <nav
      class="fixed bottom-0 z-50 w-full bg-zinc-950/90 backdrop-blur-lg border-t border-white/10 pb-safe"
    >
      <div class="flex justify-around items-center h-16">
        <a href="/" class="flex flex-col items-center gap-1 text-zinc-500">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            class="w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"
            ></path>
          </svg>
          <span class="text-[10px] font-medium">Home</span>
        </a>
        <a
          href="/search"
          class="flex flex-col items-center gap-1 text-zinc-500"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            class="w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"
            ></path>
          </svg>
          <span class="text-[10px] font-medium">Search</span>
        </a>
        <a href="/mylist" class="flex flex-col items-center gap-1 text-red-500">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="currentColor"
            viewBox="0 0 24 24"
            class="w-6 h-6"
          >
            <path d="M5 5c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2v16l-7-3-7 3V5z"
            ></path>
          </svg>
          <span class="text-[10px] font-medium">My List</span>
        </a>
        <a
          href="/profile"
          class="flex flex-col items-center gap-1 text-zinc-500"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            class="w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"
            ></path>
          </svg>
          <span class="text-[10px] font-medium">Profile</span>
        </a>
      </div>
    </nav>
  </main>
</Layout>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const container = document.getElementById("mylist-container");
    const emptyTemplate = document.getElementById("empty-state");

    // Helper: Create Card HTML
    const createCardParams = (drama) => {
      // Handle API vs LocalStorage data structure differences
      // API: drama is nested in .drama, ID is .bookId
      // LocalStorage: Item IS the drama object
      const isApi = !!drama.drama;
      const title = isApi ? drama.drama.judul : drama.title;
      const cover = isApi ? drama.drama.cover : drama.cover;
      const bookId = isApi ? drama.bookId : drama.id;
      // API might not send episodes count in bookmark list, checking...
      // If missing, we might show "Drama" or use a default.
      const episodes = isApi
        ? drama.drama.total_episode || "Ongoing"
        : drama.episodes;

      return { title, cover, bookId, episodes };
    };

    const renderList = (list) => {
      if (!container) return;
      container.innerHTML = "";

      if (!list || list.length === 0) {
        if (emptyTemplate) {
          const clone = (
            emptyTemplate as HTMLTemplateElement
          ).content.cloneNode(true);
          container.appendChild(clone);
        }
        return;
      }

      list.forEach((item: any) => {
        const { title, cover, bookId, episodes } = createCardParams(item);

        // Create Card Element Manually
        const card = document.createElement("a");
        card.href = `/detail/${bookId}`;
        card.className =
          "group relative block aspect-[3/4] overflow-hidden rounded-lg bg-gray-900 transition-transform active:scale-95 animate-in fade-in duration-300";

        // Provider Badge Logic (Frontend Side)
        let providerBadge = "";
        if (bookId.startsWith("melolo:")) {
          providerBadge = `<div class="absolute top-2 left-2 z-10 px-1.5 py-0.5 rounded text-[9px] font-bold text-white shadow-md bg-purple-600 border border-white/10">MELOLO</div>`;
        } else if (bookId.startsWith("netshort:")) {
          providerBadge = `<div class="absolute top-2 left-2 z-10 px-1.5 py-0.5 rounded text-[9px] font-bold text-white shadow-md bg-blue-600 border border-white/10">NETSHORT</div>`;
        } else if (bookId.startsWith("dramabox:")) {
          providerBadge = `<div class="absolute top-2 left-2 z-10 px-1.5 py-0.5 rounded text-[9px] font-bold text-white shadow-md bg-red-600 border border-white/10">DRAMABOX</div>`;
        } else {
          providerBadge = `<div class="absolute top-2 left-2 z-10 px-1.5 py-0.5 rounded text-[9px] font-bold text-white shadow-md bg-red-600 border border-white/10">DB</div>`;
        }

        card.innerHTML = `
                    ${providerBadge}
                    <img 
                        src="${cover}" 
                        alt="${title}" 
                        class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-110"
                        loading="lazy"
                    />
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-100"></div>
                    <div class="absolute bottom-0 left-0 w-full p-2 md:p-3 bg-gradient-to-t from-black via-black/60 to-transparent">
                        <p class="text-[10px] md:text-xs font-medium text-red-500 mb-0.5">${episodes}</p>
                        <h3 class="line-clamp-2 text-xs md:text-sm font-bold text-white leading-tight">${title}</h3>
                    </div>
                    `;
        container.appendChild(card);
      });
    };

    // Main Load Logic
    const checkAndLoad = async () => {
      const userStr = localStorage.getItem("user");
      if (userStr) {
        try {
          const user = JSON.parse(userStr);
          if (user && user.id) {
            // Fetch from API
            const res = await fetch(`/api/mylist?userId=${user.id}`);
            const json = await res.json();
            if (json.status === "success") {
              renderList(json.data);
            } else {
              console.error("API Error", json);
              // Fallback? No, if logged in, trust API.
              renderList([]);
            }
            return;
          }
        } catch (e) {
          console.error("User parse error", e);
        }
      }

      // Guest: Use LocalStorage
      const savedList = JSON.parse(
        localStorage.getItem("drama_mylist") || "[]"
      );
      renderList(savedList);
    };

    checkAndLoad();
  });
</script>

<style>
  .pb-safe {
    padding-bottom: env(safe-area-inset-bottom, 20px);
  }
</style>
