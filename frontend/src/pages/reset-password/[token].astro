---
import Layout from "../../layouts/Layout.astro";

const { token } = Astro.params;
if (!token) {
  return Astro.redirect("/forgot-password");
}
---

<Layout title="Set New Password - DramaPlay">
  <div class="fixed inset-0 bg-black z-50 flex items-center justify-center p-4">
    <!-- Starry Background -->
    <div class="absolute inset-0 z-0">
      <div
        class="absolute w-full h-full bg-[url('https://cdn.pixabay.com/photo/2016/01/27/15/25/space-1164579_1280.png')] bg-cover opacity-20"
      >
      </div>
    </div>

    <div
      class="relative z-10 w-full max-w-md bg-zinc-900 border border-white/10 rounded-2xl p-8 shadow-2xl animate-in fade-in zoom-in-95 duration-500"
    >
      <div class="text-center mb-8">
        <h1 class="text-3xl font-black text-white tracking-tight mb-2">
          New Password
        </h1>
        <p class="text-zinc-400 text-sm">
          Please enter a strong password to secure your account.
        </p>
      </div>

      <form id="reset-form" class="space-y-6">
        <div>
          <label class="block text-xs font-bold text-zinc-500 uppercase mb-2"
            >New Password</label
          >
          <input
            type="password"
            id="password"
            required
            minlength="6"
            class="w-full bg-black/50 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-red-600 focus:ring-1 focus:ring-red-600 transition-all font-medium"
            placeholder="Min. 6 characters"
          />
        </div>

        <button
          type="submit"
          class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-500 hover:to-red-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-red-900/30 active:scale-95 transition-all text-sm uppercase tracking-widest"
        >
          Update Password
        </button>
      </form>

      <!-- Loading Overlay -->
      <div
        id="loading"
        class="hidden absolute inset-0 bg-black/80 backdrop-blur-sm rounded-2xl flex flex-col items-center justify-center z-20"
      >
        <div
          class="w-10 h-10 border-4 border-red-600/30 border-t-red-600 rounded-full animate-spin mb-4"
        >
        </div>
        <p class="text-white font-bold text-sm tracking-widest animate-pulse">
          UPDATING...
        </p>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div
    id="toast"
    class="fixed top-4 left-1/2 -translate-x-1/2 bg-white text-black px-6 py-3 rounded-full shadow-2xl opacity-0 pointer-events-none transition-all duration-300 z-[60] font-bold text-sm min-w-[300px] text-center"
  >
  </div>
</Layout>

<script define:vars={{ token }}>
  const form = document.getElementById("reset-form");
  const loading = document.getElementById("loading");
  const toast = document.getElementById("toast");
  const API_URL = "/api";

  function showToast(msg, isError = false) {
    if (!toast) return;
    toast.innerText = msg;
    toast.style.backgroundColor = isError ? "#ef4444" : "#ffffff";
    toast.style.color = isError ? "#ffffff" : "#000000";
    toast.classList.remove("opacity-0", "-translate-y-4");
    setTimeout(() => {
      toast.classList.add("opacity-0", "-translate-y-4");
    }, 4000);
  }

  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const password = document.getElementById("password").value;

      loading?.classList.remove("hidden");

      try {
        const res = await fetch(`${API_URL}/reset-password/${token}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password }),
        });

        const json = await res.json();
        loading?.classList.add("hidden");

        if (json.status === "success") {
          showToast("Password updated! Redirecting...", false);
          setTimeout(() => {
            window.location.href = "/";
          }, 1500);
        } else {
          showToast(json.message || "Failed to reset password", true);
        }
      } catch (err) {
        loading?.classList.add("hidden");
        showToast("Network error. Please try again.", true);
      }
    });
  }
</script>
