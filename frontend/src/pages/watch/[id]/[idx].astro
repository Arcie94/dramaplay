---
import VideoPlayer from "../../../components/VideoPlayer.astro";
import Layout from "../../../layouts/Layout.astro";

const { id, idx } = Astro.params;

// Fetch Stream Data
// Fetch Stream Data
const API_URL = process.env.INTERNAL_API_URL || "http://backend:3000/api";
const currentIndex = idx ? parseInt(idx) - 1 : 0;
let streamData = null;
let detailJson = {};

try {
    const res = await fetch(
        `${API_URL}/stream?bookId=${id}&index=${currentIndex}`,
    );
    if (res.ok) {
        const json = await res.json();
        streamData = json.data;
    }
} catch (e) {
    console.error("Stream Fetch Error:", e);
}

if (!streamData) {
    console.error("No stream data found");
    return Astro.redirect("/404");
}

const videoUrl = streamData.chapter?.video?.mp4 || "";

// Fetch Detail for title
try {
    const detailRes = await fetch(`${API_URL}/detail?bookId=${id}`);
    if (detailRes.ok) {
        detailJson = await detailRes.json();
    }
} catch (e) {
    console.error("Detail Fetch Error (Watch Page):", e);
}

const dramaTitle = detailJson.judul || "Drama";
const coverUrl = detailJson.cover || "";

// Redefine as number for math
const currentEpNumber = idx ? parseInt(idx) : 1;
const nextUrl = `/watch/${id}/${currentEpNumber + 1}`;
const prevUrl =
    currentEpNumber > 1 ? `/watch/${id}/${currentEpNumber - 1}` : undefined;
---

<Layout title={`Watch ${dramaTitle}`}>
    <VideoPlayer
        videoUrl={videoUrl}
        coverUrl={coverUrl}
        title={`${dramaTitle} - Ep ${idx}`}
        nextUrl={nextUrl}
        prevUrl={prevUrl}
        id={id}
        dramaTitle={dramaTitle}
        totalEpisodes={detailJson.total_episode}
    />
</Layout>
