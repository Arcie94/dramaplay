---
import VideoPlayer from "../../components/VideoPlayer.astro";
import Layout from "../../layouts/Layout.astro";
import LoginLock from "../../components/LoginLock.astro";

const { slug } = Astro.params;
if (!slug) return Astro.redirect("/404");

// Parse slug to get ID and Index
// Slug format: "movie:movie/wicked-2025/1" or "dramabox:123/1"
// Last segment is always the episode index (1-based)
const parts = slug.split("/");
const idxStr = parts.pop();
const id = parts.join("/"); // Rejoin the rest as ID
const idx = idxStr ? parseInt(idxStr) : 1;

if (!id) return Astro.redirect("/404");

// Fetch Stream Data
const API_URL = process.env.INTERNAL_API_URL || "https://dramaplay.online/api";
const currentIndex = idx - 1; // 0-based for API
let streamData = null;
let videoUrl = "";
let detailJson: any = {};

const isMelolo = id.length > 15 && /^\d+$/.test(id);

try {
  if (isMelolo) {
    // 1. Fetch Detail to get VID
    const detailRes = await fetch(`${API_URL}/melolo/detail/${id}`);
    if (detailRes.ok) {
      const dJson = await detailRes.json();
      if (
        dJson.status === "success" &&
        dJson.episodes &&
        dJson.episodes[currentIndex]
      ) {
        detailJson = dJson.drama;
        const vid = dJson.episodes[currentIndex].vid;

        // 2. Fetch Stream using VID
        const streamRes = await fetch(`${API_URL}/melolo/stream/${vid}`);
        if (streamRes.ok) {
          const sJson = await streamRes.json();
          if (sJson.status === "success") {
            videoUrl = sJson.stream_url;
            streamData = sJson; // Just to pass the check below
          }
        }
      }
    }
  } else {
    // Standard API
    const res = await fetch(
      `${API_URL}/stream?bookId=${id}&index=${currentIndex}`
    );
    if (res.ok) {
      const json = await res.json();
      streamData = json.data;
      if (streamData) {
        videoUrl = streamData.chapter?.video?.mp4 || "";
      }
    }
  }
} catch (e) {
  console.error("Stream Fetch Error:", e);
}

if (!streamData) {
  console.error("No stream data found");
  // return Astro.redirect("/404"); // Temporarily allow rendering even if empty to debug
}

// Fetch Detail for title if not already loaded (Non-Melolo mainly)
if (!detailJson || !detailJson.judul) {
  try {
    const detailRes = await fetch(`${API_URL}/detail?bookId=${id}`);
    if (detailRes.ok) {
      detailJson = await detailRes.json();
    }
  } catch (e) {
    console.error("Detail Fetch Error (Watch Page):", e);
  }
}

const dramaTitle = detailJson.judul || "Drama";
const coverUrl = detailJson.cover || "";

// Redefine as number for math
const currentEpNumber = idx;
const nextUrl = `/watch/${id}/${currentEpNumber + 1}`;
const prevUrl =
  currentEpNumber > 1 ? `/watch/${id}/${currentEpNumber - 1}` : undefined;

const isMovie = id.startsWith("movie:");
---

<Layout title={`Watch ${dramaTitle}`}>
  <VideoPlayer
    videoUrl={videoUrl}
    coverUrl={coverUrl}
    title={`${dramaTitle} - Ep ${idx}`}
    nextUrl={nextUrl}
    prevUrl={prevUrl}
    id={id}
    dramaTitle={dramaTitle}
    totalEpisodes={detailJson.total_episode}
    isHorizontal={isMovie}
    isIframe={isMovie}
  />

  <LoginLock />

  <!-- Toast Notification -->
  <div
    id="toast"
    class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-white/90 text-black px-4 py-2 rounded-full shadow-lg opacity-0 pointer-events-none transition-opacity duration-300 z-50 text-sm font-bold flex items-center gap-2"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="2"
      stroke="currentColor"
      class="w-4 h-4 text-green-600"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M4.5 12.75l6 6 9-13.5"></path>
    </svg>
    <span>Link Copied!</span>
  </div>
</Layout>

<script define:vars={{ drama: detailJson }}>
  const API_URL = "/api";
  document.addEventListener("DOMContentLoaded", () => {
    const toast = document.getElementById("toast");

    function showToast(msg) {
      if (toast) {
        const span = toast.querySelector("span");
        if (span) span.innerText = msg;
        toast.classList.remove("opacity-0");
        setTimeout(() => {
          toast.classList.add("opacity-0");
        }, 2000);
      }
    }
  });
</script>
