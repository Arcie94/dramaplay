---
import VideoPlayer from "../../components/VideoPlayer.astro";
import Layout from "../../layouts/Layout.astro";
import LoginLock from "../../components/LoginLock.astro";

const { slug } = Astro.params;
if (!slug) return Astro.redirect("/404");

// Parse slug to get ID and Index
// Slug format: "movie:movie/wicked-2025/1" or "dramabox:123/1"
// Last segment is always the episode index (1-based)
const parts = slug.split("/");
const episodeNumStr = parts.pop();
const id = parts.join("/"); // Rejoin the rest as ID
const episodeNumber = episodeNumStr ? parseInt(episodeNumStr) : 1;

if (!id) return Astro.redirect("/404");

// SERVER-SIDE DEBUG: Log parsed values
console.log(`[WATCH PAGE SERVER] Slug: ${slug}`);
console.log(`[WATCH PAGE SERVER] Parsed ID: ${id}`);
console.log(`[WATCH PAGE SERVER] Parsed episodeNumber: ${episodeNumber}`);
console.log(`[WATCH PAGE SERVER] episodeNumStr: ${episodeNumStr}`);

// Fetch Stream Data
const API_URL = process.env.INTERNAL_API_URL || "https://dramaplay.online/api";
const currentIndex = episodeNumber - 1; // 0-based for API
let streamData = null;
let videoUrl = "";
let detailJson: any = {};

const isMelolo = id.length > 15 && /^\d+$/.test(id);

try {
  if (isMelolo) {
    // 1. Fetch Detail to get VID
    const detailRes = await fetch(`${API_URL}/melolo/detail/${id}`);
    if (detailRes.ok) {
      const dJson = await detailRes.json();
      if (
        dJson.status === "success" &&
        dJson.episodes &&
        dJson.episodes[currentIndex]
      ) {
        detailJson = dJson.drama;
        const vid = dJson.episodes[currentIndex].vid;

        // 2. Fetch Stream using VID
        const streamRes = await fetch(`${API_URL}/melolo/stream/${vid}`);
        if (streamRes.ok) {
          const sJson = await streamRes.json();
          if (sJson.status === "success") {
            videoUrl = sJson.stream_url;
            streamData = sJson; // Just to pass the check below
          }
        }
      }
    }
  } else {
    // Standard API
    const res = await fetch(
      `${API_URL}/stream?bookId=${id}&index=${currentIndex}`
    );
    if (res.ok) {
      const json = await res.json();
      streamData = json.data;
      if (streamData) {
        videoUrl = streamData.chapter?.video?.mp4 || "";
      }
    }
  }
} catch (e) {
  console.error("Stream Fetch Error:", e);
}

if (!streamData) {
  console.error("No stream data found");
  // return Astro.redirect("/404"); // Temporarily allow rendering even if empty to debug
}

// Fetch Detail for title if not already loaded (Non-Melolo mainly)
if (!detailJson || !detailJson.judul) {
  try {
    const detailRes = await fetch(`${API_URL}/detail?bookId=${id}`);
    if (detailRes.ok) {
      detailJson = await detailRes.json();
    }
  } catch (e) {
    console.error("Detail Fetch Error (Watch Page):", e);
  }
}

const dramaTitle = detailJson.judul || "Drama";
const coverUrl = detailJson.cover || "";

// URLs for navigation
const nextUrl = `/watch/${id}/${episodeNumber + 1}`;
const prevUrl =
  episodeNumber > 1 ? `/watch/${id}/${episodeNumber - 1}` : undefined;

const isMovie = id.startsWith("movie:");
---

<Layout title={`Watch ${dramaTitle}`}>
  <VideoPlayer
    videoUrl={videoUrl}
    coverUrl={coverUrl}
    title={`${dramaTitle} - Ep ${episodeNumber}`}
    nextUrl={nextUrl}
    prevUrl={prevUrl}
    id={id}
    dramaTitle={dramaTitle}
    totalEpisodes={detailJson.total_episode}
    isHorizontal={isMovie}
    isIframe={isMovie}
  />

  <LoginLock />

  <!-- Toast Notification -->
  <div
    id="toast"
    class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-white/90 text-black px-4 py-2 rounded-full shadow-lg opacity-0 pointer-events-none transition-opacity duration-300 z-50 text-sm font-bold flex items-center gap-2"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="2"
      stroke="currentColor"
      class="w-4 h-4 text-green-600"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M4.5 12.75l6 6 9-13.5"></path>
    </svg>
    <span>Link Copied!</span>
  </div>
</Layout>

<!-- Warning Banner (Episode 4-5 for Guests) -->
<div
  id="episode-warning-banner"
  class="hidden fixed top-20 left-0 right-0 z-40 bg-gradient-to-r from-red-600 to-pink-600 px-4 py-3 shadow-lg animate-in slide-in-from-top duration-300"
>
  <div class="max-w-4xl mx-auto flex items-center justify-between gap-4">
    <div class="flex items-center gap-3">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="2"
        stroke="currentColor"
        class="w-6 h-6 text-white shrink-0"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"
        ></path>
      </svg>
      <p class="text-white text-sm md:text-base font-medium">
        üé¨ <strong>Nikmati 1 episode lagi!</strong> Daftar gratis untuk lanjut nonton
        tanpa batas.
      </p>
    </div>
    <button
      id="warning-signup-btn"
      class="px-4 py-2 bg-white text-red-600 font-bold text-sm rounded-lg hover:bg-zinc-100 transition-colors whitespace-nowrap shrink-0"
    >
      Daftar Sekarang
    </button>
  </div>
</div>

<!-- TEMPORARY DEBUG BANNER (Remove after testing) -->
<div
  id="debug-guest-limit"
  class="fixed top-4 right-4 z-50 bg-yellow-500 text-black px-4 py-3 rounded-lg shadow-lg font-mono text-xs max-w-sm"
>
  <p class="font-bold mb-1">üêõ DEBUG INFO:</p>
  <p id="debug-watch-count">Watch Count: ...</p>
  <p id="debug-logged-in">Logged In: ...</p>
  <p id="debug-episode">Current Episode: ...</p>
  <p id="debug-should-block">Should Block: ...</p>
</div>

<script
  define:vars={{
    drama: detailJson,
    currentEp: episodeNumber,
    dramaId: id,
    slugRaw: slug,
  }}
>
  const API_URL = "/api";

  // CLIENT-SIDE DEBUG: Log received variables
  console.log("[CLIENT] Received currentEp:", currentEp);
  console.log("[CLIENT] Received dramaId:", dramaId);
  console.log(
    "[CLIENT] Received slugRaw:",
    typeof slugRaw !== "undefined" ? slugRaw : "UNDEFINED"
  );

  // Fallback if currentEp is undefined or invalid
  const CURRENT_EP = currentEp || 1;
  console.log("[CLIENT] Using CURRENT_EP:", CURRENT_EP);

  // ========== GUEST EPISODE LIMIT LOGIC ==========
  const EPISODE_LIMIT = 5; // Free episodes for guests
  const WARNING_THRESHOLD = 4; // Show warning starting at episode 4

  function checkGuestEpisodeLimit() {
    const userToken = localStorage.getItem("user_token");

    // Logged-in users have unlimited access
    if (userToken) {
      return { allowed: true, showWarning: false };
    }

    // Get guest watch data
    let watchCount = parseInt(localStorage.getItem("guest_watch_count") || "0");
    let watchedEpisodes = JSON.parse(
      localStorage.getItem("guest_watch_episodes") || "[]"
    );

    // Create unique episode ID (use CURRENT_EP fallback)
    const episodeId = `${dramaId}:${CURRENT_EP}`;

    // Only increment if not watched before
    if (!watchedEpisodes.includes(episodeId)) {
      watchedEpisodes.push(episodeId);
      watchCount++;

      // Save updated data
      localStorage.setItem("guest_watch_count", watchCount.toString());
      localStorage.setItem(
        "guest_watch_episodes",
        JSON.stringify(watchedEpisodes)
      );

      console.log(
        `[Guest Limit] Episode tracked: ${episodeId} (Total: ${watchCount})`
      );
    }

    // Determine if episode is allowed
    const allowed = watchCount <= EPISODE_LIMIT;
    const showWarning =
      watchCount >= WARNING_THRESHOLD && watchCount <= EPISODE_LIMIT;

    return { allowed, showWarning, watchCount };
  }

  function showLoginWall(reason = "episode_limit") {
    const loginLock = document.querySelector('[data-component="login-lock"]');
    if (loginLock) {
      loginLock.classList.remove("hidden");

      // Customize message for episode limit
      const modalTitle = loginLock.querySelector("h2");
      if (modalTitle && reason === "episode_limit") {
        modalTitle.textContent = "Daftar untuk Lanjut Nonton";
      }

      // Block video playback
      const video = document.querySelector("video");
      if (video) {
        video.pause();
        video.src = ""; // Clear source
      }

      console.log("[Guest Limit] Login wall activated:", reason);
    }
  }

  function showWarningBanner() {
    const banner = document.getElementById("episode-warning-banner");
    if (banner) {
      banner.classList.remove("hidden");

      // Auto-hide after 10 seconds
      setTimeout(() => {
        banner.classList.add("opacity-0");
        setTimeout(() => banner.classList.add("hidden"), 300);
      }, 10000);
    }
  }

  // Listen for login success to reset counter
  window.addEventListener("user-logged-in", () => {
    localStorage.removeItem("guest_watch_count");
    localStorage.removeItem("guest_watch_episodes");
    console.log("[Guest Limit] Counter reset after login");

    // Reload page to allow playback
    setTimeout(() => location.reload(), 500);
  });

  // ========== EXECUTE ON PAGE LOAD ==========
  document.addEventListener("DOMContentLoaded", () => {
    const { allowed, showWarning, watchCount } = checkGuestEpisodeLimit();

    // ========== UPDATE DEBUG BANNER ==========
    const debugBanner = document.getElementById("debug-guest-limit");
    if (debugBanner) {
      const userToken = localStorage.getItem("user_token");
      const isLoggedIn = localStorage.getItem("isLoggedIn");

      document.getElementById("debug-watch-count").textContent =
        `Watch Count: ${watchCount || 0}`;
      document.getElementById("debug-logged-in").textContent =
        `Logged In: ${userToken ? "YES (token)" : isLoggedIn ? "YES (flag)" : "NO"}`;
      document.getElementById("debug-episode").textContent =
        `Current Episode: ${CURRENT_EP} (raw: ${currentEp})`;
      document.getElementById("debug-should-block").textContent =
        `Should Block: ${!allowed ? "YES ‚ùå" : "NO ‚úÖ"}`;
    }

    if (!allowed) {
      // Block episode 6+
      console.log(
        `[Guest Limit] BLOCKED: ${watchCount} episodes watched (Limit: ${EPISODE_LIMIT})`
      );
      showLoginWall("episode_limit");
    } else if (showWarning) {
      // Show warning at episode 4-5
      console.log(
        `[Guest Limit] WARNING shown (${watchCount}/${EPISODE_LIMIT} watched)`
      );
      showWarningBanner();
    }

    // Warning banner signup button
    const signupBtn = document.getElementById("warning-signup-btn");
    if (signupBtn) {
      signupBtn.addEventListener("click", () => {
        showLoginWall("warning_banner_click");
      });
    }

    // ========== EXISTING TOAST LOGIC ==========
    const toast = document.getElementById("toast");

    function showToast(msg) {
      if (toast) {
        const span = toast.querySelector("span");
        if (span) span.innerText = msg;
        toast.classList.remove("opacity-0");
        setTimeout(() => {
          toast.classList.add("opacity-0");
        }, 2000);
      }
    }
  });
</script>
