---
import LoginLock from "../components/LoginLock.astro";
import Layout from "../layouts/Layout.astro";
import DramaCard from "../components/DramaCard.astro";

// Skeleton Loading Implementation
// No blocking fetches here!
export const prerender = false;

// Fetch Settings (Logo) - Keep this one small blocking fetch for Logo consistency, or move potential bottleneck.
// Ideally usage of Logo should be fast.
let siteLogo = "/favicon.png";
try {
  const API_URL = process.env.INTERNAL_API_URL || "http://localhost:3000/api";
  const settingsRes = await fetch(`${API_URL}/settings?t=${Date.now()}`);
  if (settingsRes.ok) {
    const settingsData = await settingsRes.json();
    if (settingsData.site_logo) {
      siteLogo = settingsData.site_logo;
    }
  }
} catch (e) {
  console.error(`[SSR] Error fetching settings:`, e);
}
---

<Layout title="DramaPlay - Home">
  <main class="pb-20">
    <!-- Global Login Gate (Client-side check) -->
    <LoginLock />

    <!-- Header -->
    <header
      class="sticky top-0 z-50 flex items-center justify-between bg-zinc-950/80 px-4 py-3 backdrop-blur-md"
    >
      <div class="flex items-center gap-2">
        <img
          src={siteLogo}
          alt="Logo"
          class="h-8 w-8 rounded-lg object-cover"
        />

        <span class="text-lg font-bold tracking-tight text-white"
          >DramaPlay</span
        >
      </div>
      <a href="/search" class="text-zinc-400" aria-label="Search">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="2"
          stroke="currentColor"
          class="w-6 h-6"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"
          ></path>
        </svg>
      </a>
    </header>

    <!-- Genre Navbar -->
    <div
      class="sticky top-[56px] z-40 bg-zinc-950/95 backdrop-blur-sm border-b border-white/5 py-3 px-4 flex gap-3 overflow-x-auto no-scrollbar"
    >
      {
        [
          "All",
          "Epic Fantasy & Mythology",
          "Martial Arts Action",
          "Historical Romance",
          "Palace Intrigue & Politics",
          "Modern Romance & CEO",
          "School & Youth",
          "Mystery & Detective",
          "E-Sports & Gaming",
        ].map((genre) => (
          <a
            href={
              genre === "All"
                ? "/"
                : `/search?genre=${encodeURIComponent(genre)}`
            }
            class="whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-medium bg-zinc-900 border border-white/10 text-zinc-400 hover:text-white hover:bg-zinc-800 transition-colors"
          >
            {genre}
          </a>
        ))
      }
    </div>

    <!-- Hero / Featured -->
    <div
      id="hero-section"
      class="relative w-full h-[600px] md:h-auto md:aspect-[21/9] group overflow-hidden bg-zinc-900 animate-pulse"
    >
      <!-- Skeleton Hero -->
      <div class="w-full h-full flex items-center justify-center text-zinc-700">
        <svg
          class="w-20 h-20"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          ><path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"
          ></path><path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg
        >
      </div>
    </div>

    <!-- Continue Watching Section -->
    <section id="continue-watching-section" class="mt-6 px-4 hidden">
      <div class="flex items-center gap-2 mb-4">
        <span class="text-2xl">‚è≥</span>
        <h2 class="text-lg font-bold text-white">Continue Watching</h2>
      </div>
      <div
        id="continue-watching-list"
        class="flex gap-4 overflow-x-auto pb-4 no-scrollbar snap-x scroll-smooth"
      >
        <!-- JS Populated -->
      </div>
    </section>

    <!-- Trending -->
    <section class="px-4 mt-6">
      <div class="flex items-center gap-2 mb-4">
        <span class="text-2xl">üî•</span>
        <h2 class="text-lg font-bold text-white">Trending Now</h2>
      </div>
      <!-- Skeleton Grid -->
      <div
        id="trending-grid"
        class="flex gap-3 overflow-x-auto pb-4 snap-x snap-mandatory no-scrollbar"
      >
        {
          Array(6)
            .fill(0)
            .map(() => (
              <div class="flex-shrink-0 w-[30vw] md:w-[15vw] aspect-[3/4] bg-zinc-900 rounded-lg animate-pulse" />
            ))
        }
      </div>
    </section>

    <!-- Latest Updates -->
    <section class="mt-8 px-4">
      <div class="flex items-center gap-2 mb-4">
        <span class="text-2xl">üÜï</span>
        <h2 class="text-lg font-bold text-white">Latest Updates</h2>
      </div>
      <div
        id="latest-grid"
        class="grid grid-cols-3 gap-3 md:grid-cols-4 lg:grid-cols-6"
      >
        {
          Array(6)
            .fill(0)
            .map(() => (
              <div class="aspect-[3/4] bg-zinc-900 rounded-lg animate-pulse" />
            ))
        }
      </div>
    </section>

    <!-- Recommended -->
    <section class="mt-8 px-4">
      <div class="flex items-center gap-2 mb-4">
        <span class="text-2xl">‚ú®</span>
        <h2 class="text-lg font-bold text-white">Recommended for You</h2>
      </div>
      <div
        id="random-grid"
        class="grid grid-cols-3 gap-3 md:grid-cols-4 lg:grid-cols-6"
      >
        {
          Array(6)
            .fill(0)
            .map(() => (
              <div class="aspect-[3/4] bg-zinc-900 rounded-lg animate-pulse" />
            ))
        }
      </div>
    </section>

    <!-- Romance -->
    <section class="mt-8 px-4">
      <div class="flex items-center gap-2 mb-4">
        <span class="text-2xl">‚ù§Ô∏è</span>
        <h2 class="text-lg font-bold text-white">Top Romance Selection</h2>
      </div>
      <div
        id="romance-grid"
        class="grid grid-cols-3 gap-3 md:grid-cols-4 lg:grid-cols-6"
      >
        {
          Array(6)
            .fill(0)
            .map(() => (
              <div class="aspect-[3/4] bg-zinc-900 rounded-lg animate-pulse" />
            ))
        }
      </div>
    </section>

    <!-- Action -->
    <section class="mt-8 px-4 mb-24">
      <div class="flex items-center gap-2 mb-4">
        <span class="text-2xl">‚öîÔ∏è</span>
        <h2 class="text-lg font-bold text-white">Martial Arts & Action</h2>
      </div>
      <div
        id="action-grid"
        class="grid grid-cols-3 gap-3 md:grid-cols-4 lg:grid-cols-6"
      >
        {
          Array(6)
            .fill(0)
            .map(() => (
              <div class="aspect-[3/4] bg-zinc-900 rounded-lg animate-pulse" />
            ))
        }
      </div>
    </section>

    <script is:inline>
      // Shared Logic for Card Generation
      const createCardHTML = (item, rank) => {
        let providerColor = "bg-red-600";
        let providerLabel = "DRAMABOX";
        if (item.bookId.startsWith("melolo:")) {
          providerColor = "bg-purple-600";
          providerLabel = "MELOLO";
        } else if (item.bookId.startsWith("netshort:")) {
          providerColor = "bg-blue-600";
          providerLabel = "NETSHORT";
        }

        let rankHTML = "";
        if (rank) {
          const colors =
            rank === 1
              ? "bg-yellow-500 text-yellow-950"
              : rank === 2
                ? "bg-zinc-300 text-zinc-900"
                : rank === 3
                  ? "bg-orange-600 text-white"
                  : "bg-black/60 backdrop-blur-md border border-white/10";
          rankHTML = `<div class="absolute top-0 right-0 z-10 flex h-8 w-8 items-center justify-center rounded-bl-lg font-bold text-white shadow-lg ${colors}">${rank}</div>`;
        }

        return `
              <a href="/detail/${item.bookId}" class="group relative block aspect-[3/4] overflow-hidden rounded-lg bg-gray-900 transition-transform active:scale-95 fade-in">
                  <div class="absolute top-2 left-2 z-10 px-1.5 py-0.5 rounded text-[9px] font-bold text-white shadow-md ${providerColor} border border-white/10">${providerLabel}</div>
                  <img src="${item.cover}" alt="${item.judul}" class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-110" loading="lazy" onerror="this.closest('a').remove()">
                  <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div>
                  ${rankHTML}
                  <div class="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black via-black/60 to-transparent">
                    <p class="text-[10px] font-medium text-red-500 mb-0.5">${item.total_episode || "Full"}</p>
                    <h3 class="line-clamp-2 text-xs font-bold text-white leading-tight">${item.judul}</h3>
                  </div>
              </a>
             `;
      };

      const fetchAndRender = async (url, containerId, isCarousel = false) => {
        try {
          const res = await fetch(`/api${url}`);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const json = await res.json();
          const data = json.data || [];
          const container = document.getElementById(containerId);
          if (!container) return;

          if (data.length === 0) {
            container.innerHTML =
              '<div class="col-span-full text-center text-zinc-600 text-sm py-8">No content available</div>';
            return;
          }

          if (containerId === "hero-section") {
            renderHero(data);
          } else {
            container.innerHTML = data
              .map((item, idx) =>
                createCardHTML(item, isCarousel ? idx + 1 : null)
              )
              .join("");
            if (isCarousel) container.classList.remove("animate-pulse");
          }
        } catch (e) {
          console.error("Fetch failed", url, e);
          const container = document.getElementById(containerId);
          if (container) {
            container.classList.remove("animate-pulse");
            container.innerHTML = `<div class="col-span-full text-center text-red-500 text-xs py-4">Failed to load. <button onclick="location.reload()" class="underline">Retry</button></div>`;
          }
        }
      };

      const renderHero = (data) => {
        const container = document.getElementById("hero-section");
        const item = Array.isArray(data) ? data[0] : data;
        if (!item) return;

        container.classList.remove("animate-pulse", "bg-zinc-900");
        container.innerHTML = `
              <div class="relative w-full h-full flex-shrink-0 bg-zinc-950 overflow-hidden fade-in">
                  <div class="absolute inset-0">
                    <img src="${item.cover}" class="h-full w-full object-cover opacity-60 blur-2xl scale-125 select-none">
                    <div class="absolute inset-0 bg-gradient-to-r from-zinc-950 via-zinc-950/80 to-transparent"></div>
                    <div class="absolute inset-0 bg-gradient-to-t from-zinc-950 via-zinc-950/50 to-transparent"></div>
                  </div>
                  <div class="relative w-full h-full container mx-auto px-6 md:px-12 flex items-center">
                     <div class="w-full md:w-2/3 flex flex-col justify-end md:justify-center items-start z-20 pb-12 md:pb-0">
                        <div class="bg-red-600/20 text-red-500 text-xs font-bold px-3 py-1 rounded-full mb-4 border border-red-500/20 backdrop-blur-sm">FEATURED</div>
                        <h2 class="text-3xl md:text-5xl font-black text-white mb-2 leading-tight drop-shadow-lg line-clamp-1">${item.judul}</h2>
                        <p class="text-zinc-200 text-sm md:text-lg mb-6 line-clamp-2 max-w-xl drop-shadow-md">${item.deskripsi}</p>
                        <div class="flex gap-3 md:gap-4 w-full md:w-auto">
                           <a href="/detail/${item.bookId}" class="hero-watch-btn flex-1 md:flex-none justify-center group flex items-center gap-2 md:gap-3 bg-red-600 text-white px-4 md:px-8 py-3.5 md:py-3.5 rounded-xl font-bold text-sm md:text-base shadow-xl shadow-red-900/40 hover:bg-red-700 hover:scale-105 transition-all duration-300" data-id="${item.bookId}">
                              <svg class="w-5 h-5 group-hover:animate-pulse" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd"/></svg>
                              Watch Now
                           </a>
                           <button 
                                class="hero-mylist-btn flex-1 md:flex-none justify-center flex items-center gap-2 px-4 md:px-6 py-3.5 md:py-3.5 rounded-xl font-semibold text-white bg-white/10 border border-white/20 hover:bg-white/20 transition-all backdrop-blur-md text-sm md:text-base shadow-lg"
                                data-id="${item.bookId}"
                                data-title="${item.judul}"
                                data-cover="${item.cover}"
                                data-episodes="${item.total_episode || ""}"
                            >
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0111.186 0z" />
                              </svg>
                              My List
                            </button>
                        </div>
                     </div>
                  </div>
              </div>
           `;
        // Dispatch event to notify main script that Hero is ready
        window.dispatchEvent(new CustomEvent("hero-rendered"));
      };

      // Execute in parallel
      fetchAndRender("/hero", "hero-section");
      fetchAndRender("/trending", "trending-grid", true);
      fetchAndRender("/latest", "latest-grid");
      fetchAndRender("/random", "random-grid");
      fetchAndRender(
        "/random?genre=" + encodeURIComponent("Modern Romance & CEO"),
        "romance-grid"
      );
      fetchAndRender(
        "/random?genre=" + encodeURIComponent("Martial Arts Action"),
        "action-grid"
      );
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // 1. Login/Profile Logic
        const loginBtn = document.getElementById("login-nav-btn");
        const profileBtn = document.getElementById("profile-nav-btn");

        const updateNavState = () => {
          const isLoggedIn =
            localStorage.getItem("isLoggedIn") === "true" &&
            !!localStorage.getItem("token") &&
            !!localStorage.getItem("user");
          console.log("Nav Update: IsLoggedIn =", isLoggedIn);
          if (isLoggedIn) {
            loginBtn?.classList.add("hidden");
            profileBtn?.classList.remove("hidden");
          } else {
            loginBtn?.classList.remove("hidden");
            profileBtn?.classList.add("hidden");
          }
        };

        updateNavState();
        window.addEventListener("login-success", updateNavState);

        if (loginBtn) {
          loginBtn.addEventListener("click", (e) => {
            e.preventDefault();
            if ((window as any).showLoginPopup) {
              (window as any).showLoginPopup();
            } else {
              // Fallback
              const overlay = document.getElementById("login-overlay");
              if (overlay) overlay.style.display = "flex";
            }
          });
        }

        // 2. Continue Watching Logic
        const initContinueWatching = () => {
          const section = document.getElementById("continue-watching-section");
          const list = document.getElementById("continue-watching-list");
          const userStr = localStorage.getItem("user");

          if (!section || !list || !userStr) return;

          try {
            const user = JSON.parse(userStr);
            if (!user.id) return;

            fetch(`/api/history?userId=${user.id}`)
              .then((res) => res.json())
              .then((json) => {
                if (
                  json.status === "success" &&
                  json.data &&
                  json.data.length > 0
                ) {
                  // Filter out items with missing drama, ID, or COVER
                  const validItems = json.data.filter(
                    (h: any) => h.drama && h.drama.bookId && h.drama.cover
                  );

                  if (validItems.length > 0) {
                    section.classList.remove("hidden");
                    list.innerHTML = validItems
                      .map((h: any) => {
                        if (!h.drama) return "";
                        const title = h.drama.judul;
                        const cover = h.drama.cover;
                        const displayEp = (h.episodeIdx || 0) + 1;
                        const bookId = h.drama.bookId;

                        return `
                                            <div class="min-w-[140px] w-[140px] md:min-w-[calc(20%-13px)] md:w-[calc(20%-13px)] snap-start shrink-0">
                                                <a href="/watch/${bookId}/${displayEp}" class="block group relative w-full h-full rounded-xl overflow-hidden">
                                                    <div class="aspect-[2/3] w-full overflow-hidden relative">
                                                        <img src="${cover}" 
                                                             class="w-full h-full object-cover"
                                                             onerror="this.closest('.snap-start').remove(); checkEmptySection();"
                                                        >
                                                        <div class="absolute top-2 right-2 px-2 py-0.5 bg-red-600/90 rounded text-[10px] font-bold text-white">Ep ${displayEp}</div>
                                                    </div>
                                                    <div class="p-2">
                                                        <h3 class="font-bold text-white text-sm line-clamp-1">${title}</h3>
                                                    </div>
                                                </a>
                                            </div>`;
                      })
                      .join("");

                    // Helper to hide section if all items are removed by onerror
                    (window as any).checkEmptySection = () => {
                      if (list.children.length === 0) {
                        section.classList.add("hidden");
                      }
                    };
                  }
                }
              })
              .catch((err) => console.error("History fetch error", err));
          } catch (e) {
            console.error("User parse error", e);
          }
        };

        initContinueWatching();
        window.addEventListener("login-success", initContinueWatching);
        window.addEventListener("storage", (e) => {
          if (e.key === "last_watch_update") {
            initContinueWatching();
          }
        });

        // 3. Carousel Logic (Hero & Trending)

        // --- Hero Carousel (Infinite Loop) ---
        const setupHeroCarousel = () => {
          const heroContainer = document.getElementById("hero-carousel");
          const dots = document.querySelectorAll("[data-hero-index]");

          if (!heroContainer || heroContainer.children.length <= 1) return;

          // Clone first slide for infinity effect
          const firstSlide = heroContainer.children[0];
          const clone = firstSlide.cloneNode(true);
          heroContainer.appendChild(clone);

          let currentIndex = 0;
          const realTotalSlides = heroContainer.children.length - 1; // Exclude clone
          const intervalTime = 5000;
          let autoSlideInterval: any;
          let isTransitioning = false;

          const updateDots = (index: number) => {
            const realIndex = index % realTotalSlides;
            dots.forEach((dot, i) => {
              if (i === realIndex) {
                dot.classList.remove("bg-white/50");
                dot.classList.add("bg-white", "scale-125");
              } else {
                dot.classList.add("bg-white/50");
                dot.classList.remove("bg-white", "scale-125");
              }
            });
          };

          const scrollToSlide = (index: number, smooth = true) => {
            const slide = heroContainer.children[index];
            if (slide) {
              // Use container scrollTo instead of element.scrollIntoView to avoid scrolling the whole page
              heroContainer.scrollTo({
                left: (slide as HTMLElement).offsetLeft,
                behavior: smooth ? "smooth" : "auto",
              });

              // Only update dots if we are at a "real" index or the clone (which maps to 0)
              updateDots(index);

              currentIndex = index;
            }
          };

          const nextSlide = () => {
            if (isTransitioning) return;

            currentIndex++;
            scrollToSlide(currentIndex, true);

            // If we reached the clone (last item)
            if (currentIndex === realTotalSlides) {
              isTransitioning = true;
              // Wait for smooth scroll to finish, then jump to real 0
              setTimeout(() => {
                scrollToSlide(0, false); // Instant jump
                currentIndex = 0;
                isTransitioning = false;
              }, 600); // 600ms match css current transition roughly
            }
          };

          const startAutoSlide = () => {
            stopAutoSlide();
            autoSlideInterval = setInterval(nextSlide, intervalTime);
          };

          const stopAutoSlide = () => {
            clearInterval(autoSlideInterval);
          };

          // Event Listeners for Dots
          dots.forEach((dot) => {
            dot.addEventListener("click", (e) => {
              const target = e.target as HTMLElement;
              const index = parseInt(target.dataset.heroIndex || "0");
              scrollToSlide(index, true);
              startAutoSlide();
            });
          });

          // Pause on hover
          heroContainer.addEventListener("mouseenter", stopAutoSlide);
          heroContainer.addEventListener("mouseleave", startAutoSlide);

          // Initial state
          updateDots(0);
          startAutoSlide();
        };
        setupHeroCarousel();

        // --- Trending Carousel (Infinite Auto-Slide) ---
        const setupTrendingCarousel = () => {
          const container = document.getElementById("trending-carousel");
          if (!container) return;

          // Clone content to ensure seamless loop
          const originalContent = Array.from(container.children);
          // Append clones
          originalContent.forEach((item) =>
            container.appendChild(item.cloneNode(true))
          );

          let autoSlideInterval: any;
          const intervalTime = 3000; // 3 detik per slide

          const nextSlide = () => {
            // Ambil lebar kartu pertama + gap (asumsi gap 1rem = 16px)
            // Atau lebih aman hitung dari posisi kartu kedua
            if (container.children.length < 2) return;

            const firstCard = container.children[0] as HTMLElement;
            const secondCard = container.children[1] as HTMLElement;
            const cardWidth = secondCard.offsetLeft - firstCard.offsetLeft;

            // Scroll ke kanan 1 kartu
            container.scrollBy({
              left: cardWidth,
              behavior: "smooth",
            });

            // Cek reset setelah animasi (asumsi 500ms cukup)
            setTimeout(() => {
              // Jika sudah melewati setengah (masuk ke area clone)
              // scrollWidth / 2 adalah titik awal clone (karena kita duplikasi 1x)
              if (container.scrollLeft >= container.scrollWidth / 2) {
                container.scrollLeft = 0;
              }
            }, 600);
          };

          const startAutoSlide = () => {
            stopAutoSlide();
            autoSlideInterval = setInterval(nextSlide, intervalTime);
          };

          const stopAutoSlide = () => {
            clearInterval(autoSlideInterval);
          };

          // Pause on hover
          container.addEventListener("mouseenter", stopAutoSlide);
          container.addEventListener("mouseleave", startAutoSlide);
          container.addEventListener("touchstart", stopAutoSlide);
          container.addEventListener("touchend", startAutoSlide);

          startAutoSlide();
        };
        setupTrendingCarousel();

        // 4. Hero My List Logic
        const initHeroMyList = () => {
          const btns = document.querySelectorAll<
            HTMLButtonElement | HTMLAnchorElement
          >(".hero-mylist-btn");
          const STORAGE_KEY = "drama_mylist";

          // Define update logic per button to call later
          const updateButtonState = async (
            btn: HTMLButtonElement | HTMLAnchorElement
          ) => {
            const bookId = btn.dataset.id;
            const userStr = localStorage.getItem("user");
            let user: any = null;
            try {
              if (userStr) user = JSON.parse(userStr);
            } catch (e) {}

            if (!bookId) return;

            // Check Status
            let exists = false;
            if (user && user.id) {
              try {
                const res = await fetch(
                  `/api/mylist/check/${bookId}?userId=${user.id}&_t=${Date.now()}`
                );
                const json = await res.json();
                exists = json.exists;
              } catch (e) {}
            } else {
              const list = JSON.parse(
                localStorage.getItem(STORAGE_KEY) || "[]"
              );
              exists = list.some((d: any) => d.id === bookId);
            }

            // Update UI
            if (exists) {
              btn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        Added
                     `;
            } else {
              btn.innerHTML = `
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0111.186 0z" />
                      </svg>
                      My List
                     `;
            }
          };

          // Initial Init & Click Handlers
          btns.forEach((btn) => {
            updateButtonState(btn);
            btn.addEventListener("click", async (e) => {
              e.preventDefault();
              e.stopPropagation();

              const isAdded = btn.textContent?.includes("Added");

              const userStr = localStorage.getItem("user");
              let user: any = null;
              try {
                if (userStr) user = JSON.parse(userStr);
              } catch (e) {}

              const bookId = btn.dataset.id;
              const title = btn.dataset.title;
              const cover = btn.dataset.cover;
              const episodes = btn.dataset.episodes;

              if (user && user.id) {
                if (isAdded) {
                  await fetch(`/api/mylist/${bookId}?userId=${user.id}`, {
                    method: "DELETE",
                  });
                  updateButtonState(btn);
                } else {
                  await fetch(`/api/mylist`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ userId: user.id, bookId }),
                  });
                  updateButtonState(btn);
                }
              } else {
                let list = JSON.parse(
                  localStorage.getItem(STORAGE_KEY) || "[]"
                );
                if (isAdded) {
                  list = list.filter((d: any) => d.id !== bookId);
                  updateButtonState(btn);
                } else {
                  list.push({ id: bookId, title, cover, episodes });
                  updateButtonState(btn);
                }
                localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
              }
            });
          });

          (window as any).updateHeroButtons = () => {
            btns.forEach((btn) => updateButtonState(btn));
          };
        };
        initHeroMyList();

        // Listen for Async Hero Render
        window.addEventListener("hero-rendered", () => {
          initHeroMyList();
          // Re-init Resume Button Logic too if needed, as it depends on Hero HTML
          const event = new Event("login-success"); // Reuse existing listener or call directly?
          // Actually initHeroResume is defined below. We should call it.
          // But it's defined BELOW this block in original file (Line 735).
          // We can just rely on internal call if we move line 732 down?
          // Or better: Just re-run everything via existing hooks if possible.
          // Let's just call initHeroMyList here. Resume logic is next block.
        });

        // 5. Smart Resume Button (Hero)
        const initHeroResume = () => {
          const btns = document.querySelectorAll(".hero-watch-btn");

          const updateResumeState = async (btn: HTMLAnchorElement) => {
            const bookId = btn.dataset.id;
            const userStr = localStorage.getItem("user");
            let user = null;
            try {
              if (userStr) user = JSON.parse(userStr);
            } catch (e) {}

            if (!user || !user.id || !bookId) return;

            try {
              const res = await fetch(
                `/api/history/check?userId=${user.id}&bookId=${bookId}&_t=${Date.now()}`
              );
              const json = await res.json();
              if (json.exists) {
                const nextEp = json.episodeIdx + 1; // 0-based index to 1-based display
                btn.innerHTML = `
                           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 group-hover:animate-pulse">
                              <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm14.024-.983a1.125 1.125 0 010 1.966l-5.603 3.113A1.125 1.125 0 019 15.113V8.887c0-.857.921-1.4 1.671-.983l5.603 3.113z" clip-rule="evenodd" />
                           </svg>
                           Continue Ep ${nextEp}
                         `;
                btn.setAttribute("href", `/watch/${bookId}/${nextEp}`);
              }
            } catch (e) {
              console.error("Error checking resume status:", e);
            }
          };

          btns.forEach((btn) => updateResumeState(btn as HTMLAnchorElement));
        };
        initHeroResume();
        window.addEventListener("login-success", initHeroResume);
        window.addEventListener("hero-rendered", initHeroResume);

        // Sync Events
        window.addEventListener("pageshow", () => {
          if ((window as any).updateHeroButtons)
            (window as any).updateHeroButtons();
          initHeroResume(); // Update Resume Button too
          updateNavState(); // Update Nav
        });
        document.addEventListener("visibilitychange", () => {
          if (document.visibilityState === "visible") {
            if ((window as any).updateHeroButtons)
              (window as any).updateHeroButtons();
            initHeroResume();
            updateNavState();
          }
        });

        // Realtime Sync Channel
        const syncChannel = new BroadcastChannel("dramaplay_sync");
        syncChannel.onmessage = (event) => {
          if (event.data.type === "MYLIST_UPDATE") {
            const btn = document.querySelector(
              `.hero-mylist-btn[data-id="${event.data.bookId}"]`
            );
            if (btn && (window as any).updateHeroButtons)
              (window as any).updateHeroButtons();
          }
        };
      });
    </script>

    <!-- Bottom Nav -->
    <nav
      class="fixed bottom-0 z-50 w-full bg-zinc-950/90 backdrop-blur-lg border-t border-white/10 pb-safe"
    >
      <div class="flex justify-around items-center h-16">
        <a href="/" class="flex flex-col items-center gap-1 text-red-500">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="currentColor"
            viewBox="0 0 24 24"
            class="w-6 h-6"
          >
            <path
              d="M12 5.69l5 4.5V18h-2v-6H9v6H7v-7.81l5-4.5M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3z"
            ></path>
          </svg>
          <span class="text-[10px] font-medium">Home</span>
        </a>
        <a
          href="/search"
          class="flex flex-col items-center gap-1 text-zinc-500"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            class="w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"
            ></path>
          </svg>
          <span class="text-[10px] font-medium">Search</span>
        </a>
        <a
          href="/mylist"
          class="flex flex-col items-center gap-1 text-zinc-500"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            class="w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0111.186 0z"
            ></path>
          </svg>
          <span class="text-[10px] font-medium">My List</span>
        </a>
        <a
          href="/profile"
          id="profile-nav-btn"
          class="flex flex-col items-center gap-1 text-zinc-500 hidden"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            class="w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"
            ></path>
          </svg>
          <span class="text-[10px] font-medium">Profile</span>
        </a>
        <a
          href="#"
          id="login-nav-btn"
          class="flex flex-col items-center gap-1 text-zinc-500"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            class="w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9"
            ></path>
          </svg>
          <span class="text-[10px] font-medium">Login</span>
        </a>
      </div>
    </nav>
  </main>

  <style>
    .text-shadow {
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }
    .pb-safe {
      padding-bottom: env(safe-area-inset-bottom, 20px);
    }
  </style>
</Layout>
