---
import Layout from "../layouts/Layout.astro";
import DramaCard from "../components/DramaCard.astro";
import BottomNav from "../components/BottomNav.astro";
import LoginLock from "../components/LoginLock.astro";

const page = parseInt(Astro.url.searchParams.get("page") || "1");
const API_URL = process.env.INTERNAL_API_URL || "http://backend:3000/api";

let movies = [];
let error = "";

try {
  // Explicitly fetch from provider=movie
  const res = await fetch(`${API_URL}/latest?provider=movie&page=${page}`);
  if (res.ok) {
    const json = await res.json();
    movies = json.data || [];
  } else {
    error = `Failed to fetch movies (Status: ${res.status})`;
  }
} catch (e) {
  console.error("Error fetching movies:", e);
  error = "Failed to connect to server";
}

const hasPrevPage = page > 1;
const hasNextPage = movies.length > 0; // Simple heuristic as API might not return total
---

<Layout title="Movies - DramaPlay">
  <main class="pb-24 min-h-screen bg-zinc-950">
    <!-- Global Login Gate -->
    <LoginLock />

    <!-- Header -->
    <header
      class="sticky top-0 z-30 flex items-center justify-between bg-zinc-950/90 px-4 py-3 backdrop-blur-md border-b border-white/5"
    >
      <div class="flex items-center gap-2">
        <span class="text-2xl">ðŸŽ¬</span>
        <h1 class="text-lg font-bold text-white">Movies</h1>
      </div>
      <a href="/search" class="text-zinc-400" aria-label="Search">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="2"
          stroke="currentColor"
          class="w-6 h-6"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"
          ></path>
        </svg>
      </a>
    </header>

    <!-- Content -->
    <section class="p-4">
      {
        error && (
          <div class="p-4 mb-4 bg-red-900/20 border border-red-500/20 text-red-500 rounded-lg text-sm text-center">
            {error}
          </div>
        )
      }

      {
        movies.length > 0 ? (
          <div class="grid grid-cols-3 gap-3 md:grid-cols-4 lg:grid-cols-6">
            {movies.map((movie: any) => (
              <DramaCard
                id={movie.bookId}
                title={movie.judul}
                cover={movie.cover}
                episodes="Movie"
              />
            ))}
          </div>
        ) : (
          !error && (
            <div class="flex flex-col items-center justify-center py-20 text-zinc-500">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor"
                class="w-16 h-16 mb-4 opacity-50"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 01-1.125-1.125M3.375 19.5h1.5C5.496 19.5 6 18.996 6 18.375m-3.75 12V5.625m4.875 13.875c-.621 0-1.125-.504-1.125-1.125v-9c0-.621.504-1.125 1.125-1.125m.375 0h10.5a.75.75 0 01.75.75v9.75a.75.75 0 01-.75.75h-10.5m10.5-10.5a1.125 1.125 0 011.125 1.125m0 0v10.5m-12-10.5h10.5m-10.5 0V3.375a1.125 1.125 0 011.125-1.125h9a1.125 1.125 0 011.125 1.125v2.25"
                />
              </svg>
              <p>No movies found</p>
            </div>
          )
        )
      }
    </section>

    <!-- Pagination -->
    <div class="flex justify-center items-center gap-6 py-8">
      {
        hasPrevPage && (
          <a
            href={`/movies?page=${page - 1}`}
            class="flex items-center gap-2 px-6 py-3 bg-zinc-900 border border-white/10 rounded-full text-zinc-400 hover:text-white hover:bg-zinc-800 transition-all active:scale-95"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="2"
              stroke="currentColor"
              class="w-5 h-5"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M15.75 19.5L8.25 12l7.5-7.5"
              />
            </svg>
            Previous
          </a>
        )
      }

      <span class="text-white text-lg font-bold">Page {page}</span>

      {
        hasNextPage && (
          <a
            href={`/movies?page=${page + 1}`}
            class="flex items-center gap-2 px-6 py-3 bg-red-600 text-white rounded-full font-bold shadow-lg shadow-red-900/30 hover:bg-red-700 active:scale-95 transition-all"
          >
            Next
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="2"
              stroke="currentColor"
              class="w-5 h-5"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M8.25 4.5l7.5 7.5-7.5 7.5"
              />
            </svg>
          </a>
        )
      }
    </div>

    <!-- Bottom Nav -->
    <BottomNav />
  </main>
</Layout>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Re-use logic for login button in BottomNav
    const loginBtn = document.getElementById("login-nav-btn");
    const profileBtn = document.getElementById("profile-nav-btn");

    const updateNavState = () => {
      const isLoggedIn = localStorage.getItem("isLoggedIn") === "true";
      if (isLoggedIn) {
        loginBtn?.classList.add("hidden");
        profileBtn?.classList.remove("hidden");
      } else {
        loginBtn?.classList.remove("hidden");
        profileBtn?.classList.add("hidden");
      }
    };

    updateNavState();
    if (loginBtn) {
      loginBtn.addEventListener("click", (e) => {
        e.preventDefault();
        if ((window as any).showLoginPopup) {
          (window as any).showLoginPopup();
        }
      });
    }
  });
</script>
