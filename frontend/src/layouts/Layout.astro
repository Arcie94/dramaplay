---
interface Props {
	title: string;
}

const { title } = Astro.props;

// Fetch Global Settings (GA4 ID, etc)
let gaMeasurementId = "";
let siteFavicon = "/favicon.png";
try {
    const API_URL = process.env.INTERNAL_API_URL || "http://backend:3000/api";
    const res = await fetch(`${API_URL}/settings`);
    if(res.ok) {
        const json = await res.json();
        gaMeasurementId = json.ga_measurement_id || "";
        siteFavicon = json.site_favicon || "/favicon.png";
    }
} catch(e) {
    console.error("Failed to fetch settings for layout", e);
}
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content="DramaPlay - Stream Vertical Dramas" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" /> 
        <!-- Mobile optimized viewport -->
        <!-- PWA -->
        <link rel="manifest" href="/manifest.json" />
        <meta name="theme-color" content="#09090b" />
		<link rel="icon" type="image/png" href={siteFavicon} />
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>
        
        <!-- Google Analytics 4 -->
        {gaMeasurementId && (
            <>
                <script async src={`https://www.googletagmanager.com/gtag/js?id=${gaMeasurementId}`}></script>
                <script is:inline define:vars={{ gaMeasurementId }}>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){dataLayer.push(arguments);}
                    gtag('js', new Date());
                    gtag('config', gaMeasurementId);
                </script>
            </>
        )}
        
        <script is:inline>
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', function() {
                    navigator.serviceWorker.register('/sw.js').then(function(registration) {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    }, function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
                });
            }
        </script>
	</head>
	<body class="bg-zinc-950 text-white min-h-screen">
		<slot />
	</body>
</html>

<style is:global>
    /* Hide scrollbar for Chrome, Safari and Opera */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    /* Hide scrollbar for IE, Edge and Firefox */
    .no-scrollbar {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }
</style>
