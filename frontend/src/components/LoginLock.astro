---

---

<div
    id="login-overlay"
    class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex flex-col items-center justify-center p-4 animate-in fade-in duration-500"
>
    <!-- Login Container -->
    <div
        class="relative z-10 w-full max-w-md bg-[#1a1a1a] rounded-xl shadow-2xl border border-white/10 overflow-hidden"
    >
        <div class="p-8">
            <h2 class="text-2xl font-bold text-white text-center mb-8">
                Log in to DramaPlay
            </h2>

            <div class="flex flex-col gap-3 mb-6">
                <!-- Google Button Container -->
                <div id="google-btn-container" class="w-full">
                    <!-- Fallback Button if no Client ID or Script Fails -->
                    <button
                        id="btn-google-fallback"
                        class="flex items-center justify-center gap-3 w-full bg-[#2d2d2d] hover:bg-[#3d3d3d] text-white py-2.5 rounded-lg border border-white/5 transition-colors font-medium active:scale-95"
                    >
                        <svg
                            class="w-5 h-5"
                            viewBox="0 0 24 24"
                            fill="currentColor"
                            ><path
                                d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                                fill="#4285F4"></path><path
                                d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                                fill="#34A853"></path><path
                                d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                                fill="#FBBC05"></path><path
                                d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                                fill="#EA4335"></path></svg
                        >
                        Continue with Google
                    </button>
                </div>
            </div>

            <div class="relative mb-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-white/10"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-[#1a1a1a] text-zinc-500">OR</span>
                </div>
            </div>

            <form id="login-form" class="space-y-4">
                <div
                    id="error-message"
                    class="hidden w-full bg-red-500/10 border border-red-500/20 text-red-500 text-sm px-4 py-2 rounded-lg"
                >
                    Passwords do not match!
                </div>
                <div id="username-field" class="hidden">
                    <label class="sr-only" for="username">Username</label>
                    <input
                        type="text"
                        id="username"
                        class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder-zinc-500 focus:outline-none focus:border-red-600 focus:ring-1 focus:ring-red-600 transition-colors"
                        placeholder="Username"
                    />
                </div>
                <div>
                    <label class="sr-only" for="email">Email</label>
                    <input
                        type="email"
                        id="email"
                        name="email"
                        class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder-zinc-500 focus:outline-none focus:border-red-600 focus:ring-1 focus:ring-red-600 transition-colors"
                        placeholder="Email Address"
                        required
                    />
                </div>
                <div>
                    <label class="sr-only" for="password">Password</label>
                    <div class="relative">
                        <input
                            type="password"
                            id="password"
                            name="password"
                            class="w-full bg-black/30 border border-white/10 rounded-lg pl-4 pr-10 py-2.5 text-white placeholder-zinc-500 focus:outline-none focus:border-red-600 focus:ring-1 focus:ring-red-600 transition-colors"
                            placeholder="Password"
                            required
                        />
                        <button
                            type="button"
                            class="toggle-password absolute right-3 top-1/2 -translate-y-1/2 text-zinc-400 hover:text-white focus:outline-none transition-colors"
                            data-target="password"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke-width="1.5"
                                stroke="currentColor"
                                class="w-5 h-5"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"
                                ></path>
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="flex justify-end mt-1">
                        <a
                            href="#"
                            id="forgot-link"
                            class="text-xs text-red-500 hover:text-red-400"
                            >Forgot?</a
                        >
                    </div>
                </div>

                <div id="retry-password-field" class="hidden">
                    <label class="sr-only" for="retry-password"
                        >Retry Password</label
                    >
                    <div class="relative">
                        <input
                            type="password"
                            id="retry-password"
                            name="retry_password"
                            class="w-full bg-black/30 border border-white/10 rounded-lg pl-4 pr-10 py-2.5 text-white placeholder-zinc-500 focus:outline-none focus:border-red-600 focus:ring-1 focus:ring-red-600 transition-colors"
                            placeholder="Retry Password"
                        />
                        <button
                            type="button"
                            class="toggle-password absolute right-3 top-1/2 -translate-y-1/2 text-zinc-400 hover:text-white focus:outline-none transition-colors"
                            data-target="retry-password"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke-width="1.5"
                                stroke="currentColor"
                                class="w-5 h-5"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"
                                ></path>
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <button
                    type="submit"
                    id="submit-btn"
                    class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2.5 rounded-lg shadow-lg shadow-red-900/30 transition-all active:scale-[0.98]"
                >
                    Log in
                </button>
            </form>

            <div class="mt-6 text-center text-sm text-zinc-500">
                <span id="footer-text">Don't have an account?</span>
                <button
                    id="toggle-auth"
                    class="text-red-500 hover:underline font-medium"
                    >Sign up</button
                >
            </div>
        </div>
    </div>
</div>

<script is:inline>
    // Immediate check to prevent flash or persistent overlay if logged in
    try {
        if (localStorage.getItem("isLoggedIn") === "true") {
            const ol = document.getElementById("login-overlay");
            if (ol) ol.style.display = "none";
        }
    } catch (e) {
        console.error("Login Check Error", e);
    }
</script>

<script>
    console.log("LoginLock Script Running");
    const loginForm = document.getElementById("login-form");
    const overlay = document.getElementById("login-overlay");
    const API_BASE = "/api";

    // --- Google Login Integration ---
    async function initGoogleLogin() {
        try {
            // 1. Fetch Client ID
            const res = await fetch(`${API_BASE}/settings`);
            const json = await res.json();
            const clientId = json.google_client_id;

            if (clientId) {
                // 2. Load Google Script
                const script = document.createElement("script");
                script.src = "https://accounts.google.com/gsi/client";
                script.async = true;
                script.defer = true;
                script.onload = () => {
                    // 3. Initialize Google Button
                    if (window.google) {
                        window.google.accounts.id.initialize({
                            client_id: clientId,
                            callback: handleGoogleCredential,
                        });

                        // Render Button (replaces the visual container)
                        const googleContainer = document.getElementById(
                            "google-btn-container",
                        );
                        if (googleContainer) {
                            window.google.accounts.id.renderButton(
                                googleContainer,
                                {
                                    theme: "filled_black",
                                    size: "large",
                                    width: "100%",
                                    text: "continue_with",
                                },
                            );
                        }
                    }
                };
                document.body.appendChild(script);
            }
        } catch (err) {
            console.error("Google Login Error:", err);
        }
    }

    async function handleGoogleCredential(response: any) {
        if (response.credential) {
            try {
                // 4. Verify with Backend
                const verifyRes = await fetch(`${API_BASE}/auth/google`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ credential: response.credential }),
                });

                const verifyJson = await verifyRes.json();

                if (verifyJson.status === "success") {
                    completeLogin(verifyJson.user, verifyJson.token);
                } else {
                    alert("Google Login Failed: " + verifyJson.message);
                }
            } catch (err) {
                console.error(err);
                alert("Verification Error");
            }
        }
    }

    // --- Local Login (Form or Fallback) ---
    // --- Local Login (Form or Fallback) ---
    // --- Local Login (Form or Fallback) ---
    async function localLogin(
        email: string,
        password?: string,
        name?: string,
        mode: "login" | "signup" = "login",
    ) {
        const errorMsg = document.getElementById("error-message");

        // FINAL GATEKEEPER: Strict Validation for Signup
        if (mode === "signup") {
            if (!name || name.trim() === "") {
                console.error("Signup blocked: Username is empty.");
                if (errorMsg) {
                    errorMsg.textContent =
                        "CRITICAL: Username is required for signup!";
                    errorMsg.classList.remove("hidden");
                }
                return; // STOP EXECUTION IMMEDIATELY
            }
        }

        try {
            const payload: any = { email, mode };
            if (password) payload.password = password;
            if (name) payload.name = name;

            const res = await fetch(`${API_BASE}/auth/login`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });

            const json = await res.json();
            console.log("LOGIN RESPONSE DEBUG:", json); // DEBUG

            if (json.status === "success") {
                console.log(
                    "Calling completeLogin with:",
                    json.user,
                    json.token,
                ); // DEBUG
                completeLogin(json.user, json.token);
            } else {
                if (errorMsg) {
                    errorMsg.textContent = json.message || "Login failed";
                    errorMsg.classList.remove("hidden");
                }
            }
        } catch (err) {
            console.error("Login error", err);
            // In case of network error, show it
            if (errorMsg) {
                errorMsg.textContent = "Network error. Please try again.";
                errorMsg.classList.remove("hidden");
            }
        }
    }

    function completeLogin(user: any = null, token: string = "") {
        localStorage.setItem("isLoggedIn", "true");
        if (user) {
            localStorage.setItem("user", JSON.stringify(user));
        }
        if (token) {
            localStorage.setItem("token", token);
        }
        window.dispatchEvent(new Event("login-success"));
        const errorMsg = document.getElementById("error-message");
        if (errorMsg) errorMsg.classList.add("hidden"); // Clear errors

        if (overlay) {
            overlay.classList.add("opacity-0", "pointer-events-none");
            setTimeout(() => {
                overlay.style.display = "none";
            }, 500);
        }
    }

    // Initialize logic
    initGoogleLogin();

    if (loginForm && overlay) {
        // Shared State
        let isSignup = false;

        // Elements
        const usernameInput = document.getElementById(
            "username",
        ) as HTMLInputElement;
        const retryPasswordInput = document.getElementById(
            "retry-password",
        ) as HTMLInputElement;
        const emailInput = document.getElementById("email") as HTMLInputElement;
        const passwordInput = document.getElementById(
            "password",
        ) as HTMLInputElement;

        const usernameField = document.getElementById("username-field");
        const retryPasswordField = document.getElementById(
            "retry-password-field",
        );
        const formTitle = overlay.querySelector("h2");
        const submitBtn = document.getElementById("submit-btn");
        const footerText = document.getElementById("footer-text");
        const forgotLink = document.getElementById("forgot-link");
        const toggleBtn = document.getElementById("toggle-auth");

        // Check if already logged in
        if (localStorage.getItem("isLoggedIn") === "true") {
            overlay.style.display = "none";
        }

        // Handle Form Submit
        loginForm.addEventListener("submit", (e) => {
            e.preventDefault();

            // Clear previous errors
            const errorMsg = document.getElementById("error-message");
            if (errorMsg) errorMsg.classList.add("hidden");

            // Use FormData for SCOPED validation (avoids duplicate ID issues)
            const formData = new FormData(e.target as HTMLFormElement);
            const emailRaw = formData.get("email") as string;
            const passwordRaw = formData.get("password") as string;
            const usernameRaw = formData.get("username") as string;
            const retryPasswordRaw = formData.get("retry_password") as string;

            const email = emailRaw?.trim() || "";
            const password = passwordRaw || "";
            const username = usernameRaw?.trim() || "";

            // Basic Validation (Empty Fields)
            if (!email || !password) {
                if (errorMsg) {
                    errorMsg.textContent = "Please fill in all fields.";
                    errorMsg.classList.remove("hidden");
                }
                return;
            }

            // Determine if we should treat this as signup
            // We check BOTH the state variable AND the visual state of the field as a failsafe
            const isFieldVisible =
                usernameField && !usernameField.classList.contains("hidden");
            const effectiveSignupMode = isSignup || isFieldVisible;

            if (effectiveSignupMode) {
                const retryPassword = retryPasswordRaw || "";

                // Validate Username
                if (!username) {
                    console.error("Signup Check Failed: Username is empty!");
                    if (errorMsg) {
                        errorMsg.textContent = "Username is required!";
                        errorMsg.classList.remove("hidden");
                    }
                    return;
                }

                // Validate Retry Password Empty
                if (!retryPassword) {
                    if (errorMsg) {
                        errorMsg.textContent = "Please confirm your password!";
                        errorMsg.classList.remove("hidden");
                    }
                    return;
                }

                // Validate Password Match
                if (password !== retryPassword) {
                    if (errorMsg) {
                        errorMsg.textContent = "Passwords do not match!";
                        errorMsg.classList.remove("hidden");
                    }
                    return; // Validate Failed
                }
            }

            // Proceed to Login
            if (effectiveSignupMode) {
                localLogin(email, password, username, "signup");
            } else {
                localLogin(email, password, undefined, "login");
            }
        });

        // Handle Fallback Buttons
        document
            .getElementById("btn-google-fallback")
            ?.addEventListener("click", () => {
                localLogin("google-guest@dramaplay.com"); // Fallback specific email
            });

        // Listen for Show Login Request
        window.addEventListener("show-login", () => {
            if (window.showLoginPopup) window.showLoginPopup();
        });

        // Toggle Auth Mode Logic
        if (toggleBtn) {
            toggleBtn.addEventListener("click", (e) => {
                e.preventDefault();
                isSignup = !isSignup;

                if (isSignup) {
                    if (formTitle) formTitle.textContent = "Create Account";
                    if (submitBtn) submitBtn.textContent = "Sign Up";
                    if (footerText)
                        footerText.textContent = "Already have an account?";

                    // Show Fields & Set Required
                    if (usernameField) usernameField.classList.remove("hidden");
                    if (usernameInput) usernameInput.required = true;

                    if (retryPasswordField)
                        retryPasswordField.classList.remove("hidden");
                    if (retryPasswordInput) retryPasswordInput.required = true;

                    if (forgotLink)
                        forgotLink.parentElement?.classList.add("hidden"); // Hide Forgot Password in Signup
                    toggleBtn.textContent = "Log in";
                } else {
                    if (formTitle)
                        formTitle.textContent = "Log in to DramaPlay";
                    if (submitBtn) submitBtn.textContent = "Log in";
                    if (footerText)
                        footerText.textContent = "Don't have an account?";

                    // Hide Fields & Remove Required
                    if (usernameField) usernameField.classList.add("hidden");
                    if (usernameInput) usernameInput.required = false;

                    if (retryPasswordField)
                        retryPasswordField.classList.add("hidden");
                    if (retryPasswordInput) retryPasswordInput.required = false;

                    if (forgotLink)
                        forgotLink.parentElement?.classList.remove("hidden"); // Show Forgot Password in Login
                    toggleBtn.textContent = "Sign up";
                }
            });
        }

        // Global API
        window.showLoginPopup = () => {
            overlay.style.display = "flex";
            // Force reflow
            void overlay.offsetWidth;
            overlay.classList.remove("opacity-0", "pointer-events-none");
            // Reset to Login mode by default on show
            isSignup = false;
            if (formTitle) formTitle.textContent = "Log in to DramaPlay";
            if (submitBtn) submitBtn.textContent = "Log in";
            if (footerText) footerText.textContent = "Don't have an account?";
            if (toggleBtn) toggleBtn.textContent = "Sign up";
        };
    }
    // Toggle Password Visibility Logic
    document.querySelectorAll(".toggle-password").forEach((btn) => {
        btn.addEventListener("click", (e) => {
            const button = e.currentTarget as HTMLButtonElement;
            const targetId = button.dataset.target;
            if (!targetId) return;

            const input = document.getElementById(targetId) as HTMLInputElement;
            if (!input) return;

            const isPassword = input.type === "password";
            input.type = isPassword ? "text" : "password";

            // Toggle Icon
            if (isPassword) {
                // Switch to Eye Slash (Hidden)
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />
                    </svg>
                `;
            } else {
                // Switch back to Eye (Visible)
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                `;
            }
        });
    });
</script>
